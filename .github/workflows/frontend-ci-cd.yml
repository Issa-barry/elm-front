name: Frontend CI/CD

on:
  pull_request:
    branches:
      - dev
      - pre-prod
      - main
  push:
    branches:
      - dev
      - pre-prod
      - main
  workflow_dispatch:

permissions:
  contents: read

jobs:
  # ──────────────────────────────────────────────────────────
  # BUILD — s'exécute sur toutes les branches déclenchantes.
  # La configuration Angular varie selon la branche :
  #   pre-prod → preprod
  #   main     → production
  #   autres   → production (CI strict, comme la prod)
  # ──────────────────────────────────────────────────────────
  build:
    name: Build Angular
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm install --no-audit --no-fund

      - name: Determine build configuration
        id: build-config
        run: |
          if [ "${{ github.ref }}" = "refs/heads/pre-prod" ]; then
            echo "config=preprod" >> "$GITHUB_OUTPUT"
          else
            # main + dev + toute autre branche → production
            echo "config=production" >> "$GITHUB_OUTPUT"
          fi
          echo "Angular build configuration: $(grep config "$GITHUB_OUTPUT" | cut -d= -f2)"

      - name: Build Angular bundle (${{ steps.build-config.outputs.config }})
        run: |
          node ./node_modules/@angular/cli/bin/ng build --configuration ${{ steps.build-config.outputs.config }}
          node scripts/write-version.js
          node scripts/copy-deploy.js

      - name: Validate deploy output
        run: |
          test -f dist/apollo-ng-deploy/index.html
          echo "dist/apollo-ng-deploy is ready"

      - name: Upload deploy artifact
        uses: actions/upload-artifact@v4
        with:
          name: apollo-ng-deploy
          path: dist/apollo-ng-deploy/
          if-no-files-found: error

  # ──────────────────────────────────────────────────────────
  # DEPLOY PRE-PROD — uniquement sur push/dispatch vers pre-prod
  # Secrets requis : HOSTINGER_PREPROD_FTP_*
  # ──────────────────────────────────────────────────────────
  deploy-preprod:
    name: Deploy Pre-Prod (Hostinger preprod)
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/pre-prod' && (github.event_name == 'push' || github.event_name == 'workflow_dispatch')

    steps:
      - name: Download deploy artifact
        uses: actions/download-artifact@v4
        with:
          name: apollo-ng-deploy
          path: dist/apollo-ng-deploy/

      - name: Validate required secrets (preprod)
        env:
          HOSTINGER_FTP_SERVER: ${{ secrets.HOSTINGER_PREPROD_FTP_SERVER }}
          HOSTINGER_FTP_USERNAME: ${{ secrets.HOSTINGER_PREPROD_FTP_USERNAME }}
          HOSTINGER_FTP_PASSWORD: ${{ secrets.HOSTINGER_PREPROD_FTP_PASSWORD }}
        run: |
          if [ -z "$HOSTINGER_FTP_SERVER" ] || [ -z "$HOSTINGER_FTP_USERNAME" ] || [ -z "$HOSTINGER_FTP_PASSWORD" ]; then
            echo "::error::Missing one or more required secrets: HOSTINGER_PREPROD_FTP_SERVER, HOSTINGER_PREPROD_FTP_USERNAME, HOSTINGER_PREPROD_FTP_PASSWORD"
            exit 1
          fi

      - name: Deploy to preprod /public_html/
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.HOSTINGER_PREPROD_FTP_SERVER }}
          username: ${{ secrets.HOSTINGER_PREPROD_FTP_USERNAME }}
          password: ${{ secrets.HOSTINGER_PREPROD_FTP_PASSWORD }}
          local-dir: dist/apollo-ng-deploy/
          server-dir: /public_html/

  # ──────────────────────────────────────────────────────────
  # DEPLOY PROD — uniquement sur push/dispatch vers main
  # Secrets requis : HOSTINGER_PROD_FTP_*
  # ──────────────────────────────────────────────────────────
  deploy-prod:
    name: Deploy Prod (Hostinger production)
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && (github.event_name == 'push' || github.event_name == 'workflow_dispatch')

    steps:
      - name: Download deploy artifact
        uses: actions/download-artifact@v4
        with:
          name: apollo-ng-deploy
          path: dist/apollo-ng-deploy/

      - name: Validate required secrets (prod)
        env:
          HOSTINGER_FTP_SERVER: ${{ secrets.HOSTINGER_PROD_FTP_SERVER }}
          HOSTINGER_FTP_USERNAME: ${{ secrets.HOSTINGER_PROD_FTP_USERNAME }}
          HOSTINGER_FTP_PASSWORD: ${{ secrets.HOSTINGER_PROD_FTP_PASSWORD }}
        run: |
          if [ -z "$HOSTINGER_FTP_SERVER" ] || [ -z "$HOSTINGER_FTP_USERNAME" ] || [ -z "$HOSTINGER_FTP_PASSWORD" ]; then
            echo "::error::Missing one or more required secrets: HOSTINGER_PROD_FTP_SERVER, HOSTINGER_PROD_FTP_USERNAME, HOSTINGER_PROD_FTP_PASSWORD"
            exit 1
          fi

      - name: Deploy to prod /public_html/
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.HOSTINGER_PROD_FTP_SERVER }}
          username: ${{ secrets.HOSTINGER_PROD_FTP_USERNAME }}
          password: ${{ secrets.HOSTINGER_PROD_FTP_PASSWORD }}
          local-dir: dist/apollo-ng-deploy/
          server-dir: /public_html/
