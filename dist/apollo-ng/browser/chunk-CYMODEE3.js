import{d as m}from"./chunk-7G5MAEGV.js";import{d as f}from"./chunk-64S7HSEB.js";import{A as i,P as n,T as g,Y as a,g as l,ka as h,l as c}from"./chunk-WZ5FQRRG.js";import{a as p}from"./chunk-GAL4ENT6.js";var U={production:!0,apiUrl:"https://usine-eau-api.fr/api/v1",productImagesPath:"assets/demo/images/produits/"};var d=class o{http=a(f);router=a(m);API_URL=`${U.apiUrl}/auth`;TOKEN_KEY="access_token";USER_KEY="user";currentUser=h(this.getUserFromStorage());isAuthenticated=h(this.hasToken());currentUserSubject=new l(this.getUserFromStorage());currentUser$=this.currentUserSubject.asObservable();constructor(){this.initializeAuth()}initializeAuth(){let e=this.getToken(),t=this.getUserFromStorage();e&&t?(this.currentUser.set(t),this.isAuthenticated.set(!0),this.currentUserSubject.next(t),this.refreshCurrentUserProfile()):this.clearAuth()}register(e){return this.http.post(`${this.API_URL}/register`,e).pipe(n(t=>{t.success&&t.data&&this.handleAuthSuccess(t.data)}),i(t=>this.handleError(t)))}login(e){return this.http.post(`${this.API_URL}/login`,e).pipe(n(t=>{t.success&&t.data&&this.handleAuthSuccess(t.data)}),i(t=>this.handleError(t)))}logout(){return this.http.post(`${this.API_URL}/logout`,{}).pipe(n(()=>{this.clearAuth(),this.router.navigate(["/auth/login"])}),i(e=>(this.clearAuth(),this.router.navigate(["/auth/login"]),this.handleError(e))))}logoutAll(){return this.http.post(`${this.API_URL}/logout-all`,{}).pipe(n(()=>{this.clearAuth(),this.router.navigate(["/auth/login"])}),i(e=>this.handleError(e)))}me(){return this.http.get(`${this.API_URL}/me`).pipe(n(e=>{if(e.success&&e.data){let t=this.extractUserFromPayload(e.data);t&&this.setUser(t)}}),i(e=>this.handleError(e)))}updateProfile(e){return this.http.put(`${this.API_URL}/profile`,e).pipe(n(t=>{t.success&&t.data&&this.setUser(t.data)}),i(t=>this.handleError(t)))}changePassword(e){return this.http.post(`${this.API_URL}/change-password`,e).pipe(i(t=>this.handleError(t)))}refreshToken(){return this.http.post(`${this.API_URL}/refresh-token`,{}).pipe(n(e=>{e.success&&e.data&&this.setToken(e.data.access_token)}),i(e=>this.handleError(e)))}checkToken(){return this.http.get(`${this.API_URL}/check-token`).pipe(n(e=>{e.success&&e.data?.user&&this.setUser(e.data.user)}),i(e=>this.handleError(e)))}handleAuthSuccess(e){this.setToken(e.access_token);let t=this.extractUserFromPayload(e)??e.user;this.setUser(t),this.refreshCurrentUserProfile()}setToken(e){sessionStorage.setItem(this.TOKEN_KEY,e)}getToken(){return sessionStorage.getItem(this.TOKEN_KEY)}hasToken(){return!!this.getToken()}setUser(e){sessionStorage.setItem(this.USER_KEY,JSON.stringify(e)),this.currentUser.set(e),this.isAuthenticated.set(!0),this.currentUserSubject.next(e)}getUserFromStorage(){let e=sessionStorage.getItem(this.USER_KEY);if(!e)return null;try{let t=JSON.parse(e);return this.extractUserFromPayload(t)}catch{return null}}refreshCurrentUserProfile(){this.me().subscribe({next:()=>{},error:()=>{}})}extractUserFromPayload(e){let t=e?.user??e;if(!t||typeof t!="object")return null;let r=p({},t),s=this.mergeUniqueStrings(this.normalizePermissions(t?.permissions),this.normalizePermissions(e?.permissions));s.length>0&&(r.permissions=s);let u=this.mergeUniqueStrings(this.normalizeStringList(t?.roles),this.normalizeStringList(e?.roles));return u.length>0&&(r.roles=u),r}normalizeStringList(e){return Array.isArray(e)?e.map(t=>typeof t=="string"?t.trim():t&&typeof t=="object"&&typeof t.name=="string"?t.name.trim():"").filter(t=>t.length>0):[]}normalizePermissions(e){return e?Array.isArray(e)?e.map(t=>typeof t=="string"?t.trim():t&&typeof t=="object"&&typeof t.name=="string"?t.name.trim():"").filter(t=>t.length>0):typeof e=="object"?Object.entries(e).flatMap(([t,r])=>Array.isArray(r)?r.filter(s=>typeof s=="string"&&s.trim().length>0).map(s=>`${t}.${s.trim()}`):r&&typeof r=="object"?Object.entries(r).filter(([,s])=>!!s).map(([s])=>`${t}.${s}`):typeof r=="string"&&r.trim().length>0?[`${t}.${r.trim()}`]:[]):[]:[]}mergeUniqueStrings(...e){let t=new Set;return e.flat().forEach(r=>{let s=r.trim();s.length>0&&t.add(s)}),Array.from(t)}clearAuth(){sessionStorage.removeItem(this.TOKEN_KEY),sessionStorage.removeItem(this.USER_KEY),this.currentUser.set(null),this.isAuthenticated.set(!1),this.currentUserSubject.next(null)}handleError(e){return console.error("Erreur API:",e),e.status===401&&(this.clearAuth(),this.router.navigate(["/auth/login"])),c(()=>e)}isLoggedIn(){return this.hasToken()&&this.currentUser()!==null}hasPermission(e){let t=this.currentUser();if(!t)return!1;let r=t.permissions??[];return r.length===0?!0:r.includes(e)}static \u0275fac=function(t){return new(t||o)};static \u0275prov=g({token:o,factory:o.\u0275fac,providedIn:"root"})};export{U as a,d as b};
