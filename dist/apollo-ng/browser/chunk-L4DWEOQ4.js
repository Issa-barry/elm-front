import{d as b}from"./chunk-7G5MAEGV.js";import{d as m}from"./chunk-64S7HSEB.js";import{A as i,Dc as c,P as n,T as u,Y as l,g,ka as o,l as f}from"./chunk-WZ5FQRRG.js";import{a as U}from"./chunk-GAL4ENT6.js";var _={production:!0,apiUrl:"https://usine-eau-api.fr/api/v1",productImagesPath:"assets/demo/images/produits/"};var d="usine_context",h=class a{_currentUsineId=o(null);_defaultUsineId=o(null);_isSiegeUser=o(!1);_accessibleUsines=o([]);_isConsolidated=o(!1);currentUsineId=this._currentUsineId.asReadonly();defaultUsineId=this._defaultUsineId.asReadonly();isSiegeUser=this._isSiegeUser.asReadonly();accessibleUsines=this._accessibleUsines.asReadonly();isConsolidated=this._isConsolidated.asReadonly();currentUsine=c(()=>{let e=this._currentUsineId();return e===null?null:this._accessibleUsines().find(s=>s.id===e)??null});headerUsineId=c(()=>this._isConsolidated()?null:this._currentUsineId());constructor(){this.restoreFromStorage()}hydrateFromMe(e){this._isSiegeUser.set(e.is_siege_user),this._accessibleUsines.set(e.accessible_usines??[]),this._defaultUsineId.set(e.default_usine_id);let s=e.current_usine_id??e.default_usine_id;this._currentUsineId.set(s);let t=e.is_siege_user&&s===null;this._isConsolidated.set(t),this.persist()}switchUsine(e){this._currentUsineId.set(e),this._isConsolidated.set(!1),this.persist()}enableConsolidatedView(){this._isSiegeUser()&&(this._currentUsineId.set(null),this._isConsolidated.set(!0),this.persist())}fallbackToDefault(){let e=this._defaultUsineId();if(e!==null){this.switchUsine(e);return}if(this._isSiegeUser()){this.enableConsolidatedView();return}let s=this._accessibleUsines()[0];s&&this.switchUsine(s.id)}clear(){this._currentUsineId.set(null),this._defaultUsineId.set(null),this._isSiegeUser.set(!1),this._accessibleUsines.set([]),this._isConsolidated.set(!1),sessionStorage.removeItem(d)}persist(){let e={currentUsineId:this._currentUsineId(),defaultUsineId:this._defaultUsineId(),isSiegeUser:this._isSiegeUser(),accessibleUsines:this._accessibleUsines(),isConsolidated:this._isConsolidated()};sessionStorage.setItem(d,JSON.stringify(e))}restoreFromStorage(){try{let e=sessionStorage.getItem(d);if(!e)return;let s=JSON.parse(e);this._currentUsineId.set(s.currentUsineId??null),this._defaultUsineId.set(s.defaultUsineId??null),this._isSiegeUser.set(s.isSiegeUser??!1),this._accessibleUsines.set(s.accessibleUsines??[]),this._isConsolidated.set(s.isConsolidated??!1)}catch{}}static \u0275fac=function(s){return new(s||a)};static \u0275prov=u({token:a,factory:a.\u0275fac,providedIn:"root"})};var v=class a{http=l(m);router=l(b);usineContext=l(h);API_URL=`${_.apiUrl}/auth`;TOKEN_KEY="access_token";USER_KEY="user";currentUser=o(this.getUserFromStorage());isAuthenticated=o(this.hasToken());currentUserSubject=new g(this.getUserFromStorage());currentUser$=this.currentUserSubject.asObservable();constructor(){this.initializeAuth()}initializeAuth(){let e=this.getToken(),s=this.getUserFromStorage();e&&s?(this.currentUser.set(s),this.isAuthenticated.set(!0),this.currentUserSubject.next(s),this.refreshCurrentUserProfile()):this.clearAuth()}register(e){return this.http.post(`${this.API_URL}/register`,e).pipe(n(s=>{s.success&&s.data&&this.handleAuthSuccess(s.data)}),i(s=>this.handleError(s)))}login(e){return this.http.post(`${this.API_URL}/login`,e).pipe(n(s=>{s.success&&s.data&&this.handleAuthSuccess(s.data)}),i(s=>this.handleError(s)))}logout(){return this.http.post(`${this.API_URL}/logout`,{}).pipe(n(()=>{this.clearAuth(),this.router.navigate(["/auth/login"])}),i(e=>(this.clearAuth(),this.router.navigate(["/auth/login"]),this.handleError(e))))}logoutAll(){return this.http.post(`${this.API_URL}/logout-all`,{}).pipe(n(()=>{this.clearAuth(),this.router.navigate(["/auth/login"])}),i(e=>this.handleError(e)))}me(){return this.http.get(`${this.API_URL}/me`).pipe(n(e=>{if(e.success&&e.data){let s=this.extractUserFromPayload(e.data);s&&this.setUser(s),this.usineContext.hydrateFromMe(e.data)}}),i(e=>this.handleError(e)))}updateProfile(e){return this.http.put(`${this.API_URL}/profile`,e).pipe(n(s=>{s.success&&s.data&&this.setUser(s.data)}),i(s=>this.handleError(s)))}changePassword(e){return this.http.post(`${this.API_URL}/change-password`,e).pipe(i(s=>this.handleError(s)))}refreshToken(){return this.http.post(`${this.API_URL}/refresh-token`,{}).pipe(n(e=>{e.success&&e.data&&this.setToken(e.data.access_token)}),i(e=>this.handleError(e)))}checkToken(){return this.http.get(`${this.API_URL}/check-token`).pipe(n(e=>{e.success&&e.data?.user&&this.setUser(e.data.user)}),i(e=>this.handleError(e)))}handleAuthSuccess(e){this.setToken(e.access_token);let s=this.extractUserFromPayload(e)??e.user;this.setUser(s),this.refreshCurrentUserProfile()}setToken(e){sessionStorage.setItem(this.TOKEN_KEY,e)}getToken(){return sessionStorage.getItem(this.TOKEN_KEY)}hasToken(){return!!this.getToken()}setUser(e){sessionStorage.setItem(this.USER_KEY,JSON.stringify(e)),this.currentUser.set(e),this.isAuthenticated.set(!0),this.currentUserSubject.next(e)}getUserFromStorage(){let e=sessionStorage.getItem(this.USER_KEY);if(!e)return null;try{let s=JSON.parse(e);return this.extractUserFromPayload(s)}catch{return null}}refreshCurrentUserProfile(){this.me().subscribe({next:()=>{},error:()=>{}})}extractUserFromPayload(e){let s=e?.user??e;if(!s||typeof s!="object")return null;let t=U({},s),r=this.mergeUniqueStrings(this.normalizePermissions(s?.permissions),this.normalizePermissions(e?.permissions));r.length>0&&(t.permissions=r);let p=this.mergeUniqueStrings(this.normalizeStringList(s?.roles),this.normalizeStringList(e?.roles));return p.length>0&&(t.roles=p),t}normalizeStringList(e){return Array.isArray(e)?e.map(s=>typeof s=="string"?s.trim():s&&typeof s=="object"&&typeof s.name=="string"?s.name.trim():"").filter(s=>s.length>0):[]}normalizePermissions(e){return e?Array.isArray(e)?e.map(s=>typeof s=="string"?s.trim():s&&typeof s=="object"&&typeof s.name=="string"?s.name.trim():"").filter(s=>s.length>0):typeof e=="object"?Object.entries(e).flatMap(([s,t])=>Array.isArray(t)?t.filter(r=>typeof r=="string"&&r.trim().length>0).map(r=>`${s}.${r.trim()}`):t&&typeof t=="object"?Object.entries(t).filter(([,r])=>!!r).map(([r])=>`${s}.${r}`):typeof t=="string"&&t.trim().length>0?[`${s}.${t.trim()}`]:[]):[]:[]}mergeUniqueStrings(...e){let s=new Set;return e.flat().forEach(t=>{let r=t.trim();r.length>0&&s.add(r)}),Array.from(s)}clearAuth(){sessionStorage.removeItem(this.TOKEN_KEY),sessionStorage.removeItem(this.USER_KEY),this.currentUser.set(null),this.isAuthenticated.set(!1),this.currentUserSubject.next(null),this.usineContext.clear()}handleError(e){return console.error("Erreur API:",e),e.status===401&&(this.clearAuth(),this.router.navigate(["/auth/login"])),f(()=>e)}isLoggedIn(){return this.hasToken()&&this.currentUser()!==null}hasPermission(e){let s=this.currentUser();if(!s)return!1;let t=s.permissions??[];return t.length===0?!0:t.includes(e)}static \u0275fac=function(s){return new(s||a)};static \u0275prov=u({token:a,factory:a.\u0275fac,providedIn:"root"})};export{h as a,_ as b,v as c};
