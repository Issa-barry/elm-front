<p-confirmDialog></p-confirmDialog>

<!-- Mobile: app-like list (≤768px) -->
<div class="utilisateurs-mobile-app">
  <header class="mobile-header"> 
    <button
      pButton
      pRipple
      icon="pi pi-arrow-left"
      class="p-button-rounded p-button-text mobile-back"
      aria-label="Retour à l'accueil"
      (click)="goHome()"
    ></button>
    <div class="mobile-title-wrap">
      <h1 class="mobile-title">Utilisateurs</h1> 
      <p class="mobile-subtitle">{{ mobileFilteredUsers.length }} utilisateur{{ mobileFilteredUsers.length !== 1 ? 's' : '' }}</p>
    </div>
    <p-menu
      #statusMenu
      [model]="mobileStatusMenuItems"
      [popup]="true"
      appendTo="body"
      styleClass="mobile-status-menu"
    />
    <button
      pButton
      pRipple
      icon="pi pi-filter"
      class="p-button-rounded p-button-text mobile-add"
      aria-label="Filtrer par statut"
      (click)="statusMenu.toggle($event)"
    ></button>
  </header>

  <div class="mobile-scroll">
    <section class="mobile-search">
      <p-icon-field>
        <p-inputicon class="pi pi-search" />
        <input
          pInputText
          type="text"
          [(ngModel)]="mobileSearchTerm"
          (ngModelChange)="onMobileSearchChange()"
          placeholder="Nom, email, téléphone..."
          class="w-full"
        />
      </p-icon-field>
    </section>

    <section class="mobile-list" *ngIf="!loading && mobileVisibleUsers.length; else mobileListState">
      <article
        class="mobile-user-card"
        *ngFor="let user of mobileVisibleUsers; trackBy: trackByUserId"
        (click)="goToEdit($event, user.id)"
      >
        <div class="mobile-card-avatar" aria-hidden="true">
          {{ getInitials(user.nom_complet) }}
        </div>
        <div class="mobile-card-body">
          <div class="mobile-card-name">{{ user.nom_complet }}</div>
          <div class="mobile-card-meta">{{ user.email || (user.phone | phoneFormat:'INT') }}</div>
          <div class="mobile-card-footer">
            <p-tag
              [value]="user.is_active ? 'Actif' : 'Inactif'"
              [severity]="user.is_active ? 'success' : 'danger'"
              styleClass="mobile-status-tag"
            />
            <div class="mobile-card-actions">
              <button
                pButton
                pRipple
                icon="pi pi-eye"
                class="p-button-rounded p-button-text p-button-sm"
                [pTooltip]="canUpdate ? 'Modifier' : 'Voir'"
                tooltipPosition="top"
                (click)="goToEdit($event, user.id)"
                [disabled]="!canUpdate"
              ></button>
              <button
                *ngIf="canDelete"
                pButton
                pRipple
                icon="pi pi-trash"
                class="p-button-rounded p-button-text p-button-danger p-button-sm"
                [pTooltip]="'Supprimer'"
                tooltipPosition="top"
                (click)="$event.stopPropagation(); deleteUser($event, user.id)"
              ></button>
            </div>
          </div>
        </div>
      </article>
    </section>

    <ng-template #mobileListState>
      <div class="mobile-state" *ngIf="loading">Chargement...</div>
      <div class="mobile-state" *ngIf="!loading && !mobileFilteredUsers.length">Aucun utilisateur.</div>
    </ng-template>

    <div class="mobile-load-more" *ngIf="!loading && canLoadMoreMobile">
      <button pButton label="Charger plus" icon="pi pi-angle-down" class="mobile-load-more-btn" (click)="loadMoreMobile()"></button>
    </div>
  </div>

  <button
    *ngIf="canCreate"
    type="button"
    class="mobile-fab"
    aria-label="Nouveau utilisateur"
    (click)="navigateToCreate()"
  >
    <i class="pi pi-user-plus"></i>
  </button>
</div>

<!-- Desktop: table -->
<div class="card utilisateurs-desktop">
  <p-table
    #dt
    [value]="users"
    [paginator]="true"
    paginatorDropdownAppendTo="body"
    [rows]="10"
    [showCurrentPageReport]="true"
    [loading]="loading"
    responsiveLayout="scroll"
    currentPageReportTemplate="  {first} / {last} de {totalRecords} entrées"
    [rowsPerPageOptions]="[10, 25, 50]"
    [globalFilterFields]="['nom_complet', 'email', 'phone', 'reference', 'pays', 'ville']"
    selectionMode="single"
    [(selection)]="selectedUser"
    (onRowSelect)="onRowSelect($event)"
    [rowHover]="true"
    styleClass="cursor-pointer"
  >
    <ng-template #caption>
      <div class="flex flex-wrap gap-2 items-center justify-between">
        <p-icon-field class="w-full sm:w-80 order-1 sm:order-0">
          <p-inputicon class="pi pi-search" />
          <input
            pInputText
            type="text"
            (input)="onGlobalFilter(dt, $event)" 
            placeholder="Rechercher un utilisateur..."
            class="w-full"
          />
        </p-icon-field>

        <div class="flex gap-2 w-full sm:w-auto flex-order-0 sm:flex-order-1">
          <!-- Filtre par statut -->
          <p-select
            [options]="statusOptions"
            [(ngModel)]="selectedStatus"
            (onChange)="filterByStatus()"
            placeholder="Tous les statuts"
            [style]="{ 'min-width': '150px' }"
            [showClear]="true"
          ></p-select>

          <!-- Bouton Nouveau -->
          <button
            *ngIf="canCreate"
            (click)="navigateToCreate()"
            pButton
            outlined
            class="flex-shrink-0"
            icon="pi pi-user-plus"
            label="Nouveau"
          ></button>
        </div>
      </div>
    </ng-template>

    <ng-template #header>
      <tr>
        <th pSortableColumn="nom_complet" class="white-space-nowrap" style="width:25%">
          <span class="flex items-center gap-2">
            Nom complet <p-sortIcon field="nom_complet"></p-sortIcon>
          </span>
        </th>

        <th pSortableColumn="phone" class="white-space-nowrap" style="width:15%">
          <span class="flex items-center gap-2">
            Téléphone <p-sortIcon field="phone"></p-sortIcon>
          </span>
        </th>
        <th class="white-space-nowrap" style="width:12%">
          <span class="flex items-center gap-2">
            Rôle
          </span>
        </th>
        <th pSortableColumn="pays" class="white-space-nowrap" style="width:18%">
          <span class="flex items-center gap-2">
            Adresse <p-sortIcon field="pays"></p-sortIcon>
          </span>
        </th>
        <th pSortableColumn="is_active" class="white-space-nowrap" style="width:10%">
          <span class="flex items-center gap-2">
            Statut <p-sortIcon field="is_active"></p-sortIcon>
          </span>
        </th>
        <th class="white-space-nowrap" style="width:10%">
          Actions
        </th>
      </tr>
    </ng-template>

    <ng-template #body let-user>
      <tr [pSelectableRow]="user">
        <td>
          <div class="flex items-center gap-2">
            <div class="flex items-center justify-center w-10 h-10 rounded-full bg-primary-100 text-primary-700 font-semibold">
              {{ getInitials(user.nom_complet) }}
            </div>
            <div>
              <div class="font-semibold">{{ user.nom_complet }}</div>
              <div class="text-sm text-surface-500 mt-1">{{ user.reference }}</div>
            </div>
          </div>
        </td>
        <td>
          <div class="flex items-center gap-1">
             <span class="text-surface-700">{{ user.phone | phoneFormat:'INT' }}</span>
          </div>
        </td>
        <td>
          <ng-container *ngIf="(user.role_names?.length || user.roles?.length); else noRole">
            <p-tag
              *ngFor="let role of (user.role_names || user.roles)"
              [value]="role"
              [severity]="getRoleSeverity(role)"
              class="mr-1"
            ></p-tag>
          </ng-container>
          <ng-template #noRole>
            <span class="text-surface-400">-</span>
          </ng-template>
        </td>
        <td>
          <div class="flex items-center gap-2">
            <span class="fi fi-{{ user.code_pays?.toLowerCase() }} text-xl"></span>
            <div>
              <div class="font-medium">{{ user.ville }}</div>
              <div class="text-sm text-surface-500">{{ user.quartier }}</div>
            </div>
          </div>
        </td>
        <td>
          <p-tag
            [value]="user.is_active ? 'Actif' : 'Inactif'"
            [severity]="user.is_active ? 'success' : 'danger'"
          ></p-tag>
        </td>
        <td>
          <div class="flex gap-2">
            <button
              pButton
              pRipple
              icon="pi pi-eye"
              class="p-button-rounded p-button-text p-button-sm"
              [pTooltip]="canUpdate ? 'Modifier' : 'Voir'"
              tooltipPosition="top"
              (click)="goToEdit($event, user.id)"
              [disabled]="!canUpdate"
            ></button>
            <button
              *ngIf="canUpdate"
              pButton
              pRipple
              [icon]="user.is_active ? 'pi pi-lock-open' : 'pi pi-lock'"
              class="p-button-rounded p-button-text p-button-sm"
              [class.p-button-success]="user.is_active"
              [class.p-button-danger]="!user.is_active"
              [pTooltip]="user.is_active ? 'Désactiver' : 'Activer'"
              tooltipPosition="top"
              (click)="toggleStatus($event, user.id)"
            ></button>
            <button
              *ngIf="canDelete"
              pButton
              pRipple
              icon="pi pi-trash"
              class="p-button-rounded p-button-text p-button-danger p-button-sm"
              [pTooltip]="'Supprimer'"
              tooltipPosition="top"
              (click)="deleteUser($event, user.id)"
            ></button>
          </div>
        </td>
      </tr>
    </ng-template>

    <ng-template #emptymessage>
      <tr>
        <td colspan="6" class="text-center py-8">
          <div class="flex flex-col items-center gap-3 text-surface-500">
            <i class="pi pi-users text-4xl"></i>
            <span>Aucun utilisateur trouvé</span>
          </div>
        </td>
      </tr>
    </ng-template>
  </p-table>
</div>
