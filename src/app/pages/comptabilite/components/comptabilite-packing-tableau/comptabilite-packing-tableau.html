<p-toast />

<div class="card">
    <p-toolbar styleClass="mb-12">
        <ng-template #start>
            <div class="flex items-center gap-4">
                <div>
                    <label class="block text-sm font-medium mb-1">Période début</label>
                    <p-datepicker
                        [(ngModel)]="filtrePeriodeDebut"
                        dateFormat="dd/mm/yy"
                        [showIcon]="true"
                        placeholder="Début"
                        inputStyleClass="w-full"
                        styleClass="w-48"
                    />
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Période fin</label>
                    <p-datepicker
                        [(ngModel)]="filtrePeriodeFin"
                        dateFormat="dd/mm/yy"
                        [showIcon]="true"
                        placeholder="Fin"
                        inputStyleClass="w-full"
                        styleClass="w-48"
                    />
                </div>
                <div class="flex items-end h-full pt-5">
                    <p-button label="Filtrer" icon="pi pi-filter" severity="secondary" (onClick)="loadComptabilite()" />
                </div>
            </div>
        </ng-template>

        <ng-template #end>
            <p-button label="Export" icon="pi pi-download" severity="secondary" (onClick)="exportCSV()" />
        </ng-template>
    </p-toolbar>

    <p-table
        #dt
        [value]="prestataires()"
        [rows]="10"
        [columns]="cols"
        [paginator]="true"
        [globalFilterFields]="filterFields"
        [tableStyle]="{ 'min-width': '90rem' }"
        [(selection)]="selectedPrestataires"
        [rowHover]="true"
        dataKey="prestataire_id"
        currentPageReportTemplate="  {first} à {last} sur {totalRecords} prestataires"
        [showCurrentPageReport]="true"
        [rowsPerPageOptions]="[10, 20, 30]"
        [loading]="loading"
    >
        <ng-template #caption>
            <div class="flex items-center justify-between">
                <h5 class="m-0">Comptabilité Packings - Récapitulatif par prestataire</h5>
                <p-iconfield>
                    <p-inputicon styleClass="pi pi-search" />
                    <input pInputText type="text" (input)="onGlobalFilter(dt, $event)" placeholder="Rechercher..." />
                </p-iconfield>
            </div>
        </ng-template>
        <ng-template #header>
            <tr>
                <th style="width: 3rem">
                    <p-tableHeaderCheckbox />
                </th>
                <th pSortableColumn="prestataire_nom" style="min-width: 14rem">
                    <span class="flex items-center gap-2">Prestataire
                    <p-sortIcon field="prestataire_nom" /></span>
                </th>
                <th style="min-width: 10rem">Téléphone</th>
               
                <th pSortableColumn="montant_non_facture" style="min-width: 10rem">
                    <span class="flex items-center gap-2">Total
                    <p-sortIcon field="montant_non_facture" /></span>
                </th>
                <th pSortableColumn="montant_facture" style="min-width: 10rem">
                    <span class="flex items-center gap-2">Payé
                    <p-sortIcon field="montant_facture" /></span>
                </th> 
                <th pSortableColumn="montant_total_du" style="min-width: 12rem">
                    <span class="flex items-center gap-2">Total dû
                    <p-sortIcon field="montant_total_du" /></span>
                </th>
                <th pSortableColumn="statut" style="min-width: 12rem">
                    <span class="flex items-center gap-2">Statut
                    <p-sortIcon field="statut" /></span>
                </th>
                <th style="min-width: 10rem"></th>
            </tr>
        </ng-template>
        <ng-template #body let-item>
            <tr>
                <td style="width: 3rem">
                    <p-tableCheckbox [value]="item" />
                </td>
                <td>
                    <span class="font-semibold">{{ item.prestataire_nom }}</span>
                </td>
                <td>{{ item.prestataire_phone }}</td>
              
                 <td class="font-bold text-primary text-lg">{{ formatCurrency(item.montant_facture) }}</td>
                <td class="text-green-600 font-semibold">{{ formatCurrency(item.montant_verse) }}</td>
                <td>
                    <span [class]="item.montant_restant_facture > 0 ? 'text-orange-500 font-semibold' : ''">
                        {{ formatCurrency(item.montant_restant_facture) }}
                    </span>
                </td>
                <!-- <td class="font-bold text-primary text-lg">{{ formatCurrency(item.montant_total_du) }}</td> -->
                <td>
                    <p-tag *ngIf="item.statut === 'impaye'" value="Impayé" severity="danger" />
                    <p-tag *ngIf="item.statut === 'partiel'" value="Partiel" severity="warn" />
                    <p-tag *ngIf="item.statut === 'solde'" value="Soldé" severity="success" />
                </td>
                <td>
                    <p-button icon="pi pi-wallet" severity="success" class="mr-2" [rounded]="true" [outlined]="true" pTooltip="Payer" (click)="openVersement(item)" />
                    <p-button icon="pi pi-eye" severity="info" [rounded]="true" [outlined]="true" pTooltip="Prévisualiser" (click)="openPreview(item)" *ngIf="item.nb_packings_non_factures > 0" />
                </td>
            </tr>
        </ng-template>

    </p-table>
</div>

<!-- Dialog Prévisualisation -->
<p-dialog [(visible)]="previewDialog" [style]="{ width: '850px' }" header="Prévisualisation des packings" [modal]="true">
    <ng-template #content>
        <div class="flex flex-col gap-4" *ngIf="previewData">
            <div class="flex items-center justify-between bg-surface-100 dark:bg-surface-800 rounded-lg p-4">
                <div>
                    <span class="font-bold">{{ previewData.nb_packings }}</span> packing(s) -
                    <span class="font-bold">{{ previewData.total_rouleaux }}</span> rouleaux
                </div>
                <div class="text-xl font-bold text-primary">{{ formatCurrency(previewData.montant_total) }}</div>
            </div>

            <p-table [value]="previewData.packings" [rows]="10" [paginator]="previewData.packings.length > 10" [rowHover]="true">
                <ng-template #header>
                    <tr>
                        <th>Référence</th>
                        <th>Début</th>
                        <th>Fin</th>
                        <th>Rouleaux</th>
                        <th>Montant</th>
                    </tr>
                </ng-template>
                <ng-template #body let-packing>
                    <tr>
                        <td>{{ packing.reference }}</td>
                        <td>{{ formatDateDisplay(packing.date_debut) }}</td>
                        <td>{{ formatDateDisplay(packing.date_fin) }}</td>
                        <td>{{ packing.nb_rouleaux }}</td>
                        <td class="font-bold">{{ formatCurrency(packing.montant) }}</td>
                    </tr>
                </ng-template>
            </p-table>
        </div>
        <div *ngIf="previewLoading" class="flex items-center justify-center p-8">
            <i class="pi pi-spin pi-spinner text-4xl"></i>
        </div>
    </ng-template>

    <ng-template #footer>
        <p-button label="Fermer" icon="pi pi-times" text (click)="previewDialog = false" />
        <p-button label="Payer" icon="pi pi-wallet" severity="success" (click)="previewDialog = false; openVersement(selectedItem!)" *ngIf="selectedItem" />
    </ng-template>
</p-dialog>

<!-- Dialog Paiement -->
<p-dialog [(visible)]="versementDialog" [style]="{ width: '550px' }" header="Payer" [modal]="true">
    <ng-template #content>
        <div class="flex flex-col gap-4" *ngIf="selectedItem">
            <!-- Nom + Total dû -->
            <div class="flex items-center justify-between">
                <span class="font-bold text-lg">{{ selectedItem.prestataire_nom }}</span>
                <p-tag [value]="selectedItem.prestataire_type" severity="info" *ngIf="selectedItem.prestataire_type" />
            </div>

            <!-- Loading -->
            <div *ngIf="versementLoading" class="flex items-center justify-center p-6">
                <i class="pi pi-spin pi-spinner text-3xl"></i>
            </div>

            <!-- Facturer d'abord si pas de factures -->
            <div *ngIf="!versementLoading && facturesPrestataire.length === 0 && selectedItem.nb_packings_non_factures > 0" class="text-center p-4">
                <p class="mb-4 text-surface-500">{{ selectedItem.nb_packings_non_factures }} packing(s) à facturer avant de payer</p>
                <p-button
                    label="Facturer"
                    icon="pi pi-money-bill"
                    severity="warn"
                    (click)="facturerNonFactures()"
                    [loading]="facturerLoading"
                />
            </div>

            <!-- Formulaire versement -->
            <div *ngIf="!versementLoading && selectedFacture">
                <!-- Bandeau facturation si non-facturés restants -->
                <div *ngIf="selectedItem.nb_packings_non_factures > 0" class="flex items-center justify-between bg-orange-50 dark:bg-orange-900/20 rounded-lg p-3 mb-4">
                    <span class="text-sm">{{ selectedItem.nb_packings_non_factures }} packing(s) non facturé(s)</span>
                    <p-button label="Facturer" size="small" severity="warn" [outlined]="true" (click)="facturerNonFactures()" [loading]="facturerLoading" />
                </div>

                <!-- Sélection facture si plusieurs -->
                <div *ngIf="facturesPrestataire.length > 1" class="mb-4">
                    <label class="block font-bold mb-2">Facture</label>
                    <p-select
                        [(ngModel)]="selectedFacture"
                        [options]="facturesPrestataire"
                        optionLabel="reference"
                        placeholder="Sélectionner"
                        styleClass="w-full"
                        (onChange)="onFactureChange()"
                    />
                </div>

                <div class="bg-surface-100 dark:bg-surface-800 rounded-lg p-3 mb-4">
                    <div class="flex items-center justify-between mb-1">
                        <span class="text-sm text-surface-500">{{ selectedFacture.reference }}</span>
                        <p-tag [value]="selectedFacture.statut_label" [severity]="selectedFacture.statut === 'impayee' ? 'danger' : 'warn'" />
                    </div>
                    <div class="grid grid-cols-3 gap-2 mt-2">
                        <div>
                            <span class="text-xs text-surface-500">Total facture</span>
                            <div class="font-bold">{{ formatCurrency(selectedFacture.montant_total) }}</div>
                        </div>
                        <div>
                            <span class="text-xs text-surface-500">Versé</span>
                            <div class="font-bold text-green-600">{{ formatCurrency(selectedFacture.montant_verse) }}</div>
                        </div>
                        <div>
                            <span class="text-xs text-surface-500">Restant</span>
                            <div class="font-bold text-orange-500">{{ formatCurrency(selectedFacture.montant_restant) }}</div>
                        </div>
                    </div>
                </div>

                <div class="flex flex-col gap-4">
                    <div>
                        <label class="block font-bold mb-2">Montant à verser</label>
                        <p-inputnumber
                            [(ngModel)]="versementData.montant"
                            [min]="1"
                            [max]="selectedFacture.montant_restant"
                            suffix=" GNF"
                            [useGrouping]="true"
                            locale="fr-FR"
                            inputStyleClass="w-full"
                            styleClass="w-full"
                        />
                        <small class="text-red-500" *ngIf="versementSubmitted && !versementData.montant">Requis.</small>
                    </div>

                    <div>
                        <label class="block font-bold mb-2">Mode de paiement</label>
                        <p-select
                            [(ngModel)]="versementData.mode_paiement"
                            [options]="modesPaiement"
                            optionLabel="label"
                            optionValue="value"
                            styleClass="w-full"
                        />
                    </div>

                    <div>
                        <label class="block font-bold mb-2">Notes</label>
                        <textarea pTextarea [(ngModel)]="versementData.notes" rows="2" class="w-full"></textarea>
                    </div>
                </div>
            </div>

            <!-- Aucune facture et aucun non-facturé -->
            <div *ngIf="!versementLoading && facturesPrestataire.length === 0 && selectedItem.nb_packings_non_factures === 0" class="text-center p-4 text-surface-500">
                Aucun paiement en cours.
            </div>
        </div>
    </ng-template>

    <ng-template #footer>
        <p-button label="Annuler" icon="pi pi-times" text (click)="hideVersementDialog()" [disabled]="versementSaving" />
        <p-button
            label="Payer"
            icon="pi pi-check"
            severity="success"
            (click)="saveVersement()"
            [disabled]="versementSaving || !selectedFacture"
            [loading]="versementSaving"
        />
    </ng-template>
</p-dialog>

<!-- Dialog Historique Versements -->
<p-dialog [(visible)]="historiqueDialog" [style]="{ width: '750px' }" header="Historique des versements" [modal]="true">
    <ng-template #content>
        <div *ngIf="historiqueLoading" class="flex items-center justify-center p-8">
            <i class="pi pi-spin pi-spinner text-4xl"></i>
        </div>

        <div *ngIf="historiqueData" class="flex flex-col gap-4">
            <!-- Résumé facture -->
            <div class="bg-surface-100 dark:bg-surface-800 rounded-lg p-4">
                <div class="flex items-center justify-between mb-2">
                    <span class="font-bold text-lg">{{ historiqueData.reference }}</span>
                    <p-tag [value]="historiqueData.is_soldee ? 'Soldé' : 'En cours'" [severity]="historiqueData.is_soldee ? 'success' : 'warn'" />
                </div>
                <div class="grid grid-cols-12 gap-4">
                    <div class="col-span-4">
                        <span class="text-sm text-surface-500">Montant total</span>
                        <div class="font-bold">{{ formatCurrency(historiqueData.montant_total) }}</div>
                    </div>
                    <div class="col-span-4">
                        <span class="text-sm text-surface-500">Versé</span>
                        <div class="font-bold text-green-600">{{ formatCurrency(historiqueData.montant_verse) }}</div>
                    </div>
                    <div class="col-span-4">
                        <span class="text-sm text-surface-500">Restant</span>
                        <div class="font-bold text-orange-500">{{ formatCurrency(historiqueData.montant_restant) }}</div>
                    </div>
                </div>
            </div>

            <!-- Liste versements -->
            <p-table [value]="historiqueData.versements" [rowHover]="true" *ngIf="historiqueData.versements.length > 0">
                <ng-template #header>
                    <tr>
                        <th>Date</th>
                        <th>Montant</th>
                        <th>Mode</th>
                        <th>Notes</th>
                        <th></th>
                    </tr>
                </ng-template>
                <ng-template #body let-versement>
                    <tr>
                        <td>{{ formatDateDisplay(versement.date_versement) }}</td>
                        <td class="text-green-600 font-bold">{{ formatCurrency(versement.montant) }}</td>
                        <td>{{ versement.mode_paiement_label }}</td>
                        <td>{{ versement.notes || '-' }}</td>
                        <td>
                            <p-button icon="pi pi-trash" severity="danger" [rounded]="true" [outlined]="true" [text]="true" pTooltip="Supprimer" (click)="confirmDeleteVersement(historiqueData!.facture_id, versement)" />
                        </td>
                    </tr>
                </ng-template>
            </p-table>

            <div *ngIf="historiqueData.versements.length === 0" class="text-center p-4 text-surface-500">
                Aucun versement enregistré.
            </div>
        </div>
    </ng-template>

    <ng-template #footer>
        <p-button label="Fermer" icon="pi pi-times" text (click)="historiqueDialog = false" />
    </ng-template>
</p-dialog>

<p-confirmdialog [style]="{ width: '450px' }" />
