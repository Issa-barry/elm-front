<p-toast />

<div class="card tableau-card">
    <p-table
        #dt
        [value]="prestataires()"
        [rows]="10"
        [columns]="cols"
        [paginator]="true"
        [globalFilterFields]="filterFields"
        [tableStyle]="{ 'min-width': '55rem' }"
        [(selection)]="selectedPrestataires"
        [rowHover]="true"
        dataKey="prestataire_id"
        currentPageReportTemplate="{first} à {last} sur {totalRecords} prestataires"
        [showCurrentPageReport]="true"
        [rowsPerPageOptions]="[10, 20, 30]"
        [loading]="loading"
    >
        <!-- Caption = filters + search -->
        <ng-template #caption>
            <div class="table-caption mb-4">
                <div class="table-caption__filters">
                    <p-datepicker
                        [(ngModel)]="filtrePeriodeDebut"
                        dateFormat="dd/mm/yy"
                        [showIcon]="true"
                        placeholder="Date début"
                        inputStyleClass="w-full"
                        styleClass="w-40"
                    />
                    <p-datepicker
                        [(ngModel)]="filtrePeriodeFin"
                        dateFormat="dd/mm/yy"
                        [showIcon]="true"
                        placeholder="Date fin"
                        inputStyleClass="w-full"
                        styleClass="w-40"
                    />
                    <p-select
                        [(ngModel)]="filtreStatut"
                        [options]="statutOptions"
                        optionLabel="label"
                        optionValue="value"
                        placeholder="Statut"
                        styleClass="w-32"
                        (onChange)="applyStatutFilter()"
                    />
                    <p-button icon="pi pi-filter" severity="primary" [rounded]="true" [outlined]="true" pTooltip="Appliquer les filtres" (onClick)="loadComptabilite()" />
                </div>
                <div class="table-caption__actions">
                    <p-iconfield>
                        <p-inputicon styleClass="pi pi-search" />
                        <input pInputText type="text" (input)="onGlobalFilter(dt, $event)" placeholder="Rechercher..." />
                    </p-iconfield>
                    <p-button icon="pi pi-download" severity="secondary" [rounded]="true" [text]="true" pTooltip="Exporter" (onClick)="exportCSV()" />
                </div>
            </div>
        </ng-template>

        <ng-template #header>
            <tr>
                <th pSortableColumn="prestataire_nom">
                    <span class="col-header">Prestataire <p-sortIcon field="prestataire_nom" /></span>
                </th>
                <th><span class="col-header">Téléphone</span></th>
                <th pSortableColumn="derniere_date">
                    <span class="col-header">Date <p-sortIcon field="derniere_date" /></span>
                </th>
                <th pSortableColumn="montant_facture" class="text-right">
                    <span class="col-header justify-end">Total <p-sortIcon field="montant_facture" /></span>
                </th>
                <th pSortableColumn="montant_verse" class="text-right">
                    <span class="col-header justify-end">Payé <p-sortIcon field="montant_verse" /></span>
                </th>
                <th pSortableColumn="montant_restant_facture" class="text-right">
                    <span class="col-header justify-end">Reste dû <p-sortIcon field="montant_restant_facture" /></span>
                </th>
                <th pSortableColumn="statut" class="text-center">
                    <span class="col-header justify-center">Statut <p-sortIcon field="statut" /></span>
                </th>
                <th class="text-center" style="width: 5rem"></th>
            </tr>
        </ng-template>

        <ng-template #body let-item>
            <tr class="table-row" (dblclick)="goToDetail(item)">
                <td>
                    <div class="cell-prestataire">
                        <span class="cell-prestataire__avatar" [style.background]="'var(--p-primary-50)'" [style.color]="'var(--p-primary-600)'">
                            {{ item.prestataire_nom?.charAt(0)?.toUpperCase() }}
                        </span>
                        <span class="cell-prestataire__name">{{ item.prestataire_nom }}</span>
                    </div>
                </td>
                <td class="cell-secondary">{{ item.prestataire_phone }}</td>
                <td class="cell-secondary">{{ formatDateDisplay(item.derniere_date) }}</td>
                <td class="text-right cell-mono">{{ formatCurrency(item.montant_facture) }}</td>
                <td class="text-right cell-mono cell-success">{{ formatCurrency(item.montant_verse) }}</td>
                <td class="text-right cell-mono cell-bold">{{ formatCurrency(item.montant_restant_facture) }}</td>
                <td class="text-center">
                    <span class="status-badge" [ngClass]="{
                        'status-badge--danger': item.statut === 'impaye',
                        'status-badge--warn': item.statut === 'partiel',
                        'status-badge--success': item.statut === 'solde'
                    }">
                        {{ item.statut === 'impaye' ? 'Impayé' : item.statut === 'partiel' ? 'Partiel' : 'Soldé' }}
                    </span>
                </td>
                <td class="text-center">
                    <p-button icon="pi pi-arrow-right" severity="secondary" [text]="true" [rounded]="true" pTooltip="Détail" (click)="goToDetail(item)" />
                </td>
            </tr>
        </ng-template>

        <ng-template #emptymessage>
            <tr>
                <td colspan="8">
                    <div class="empty-state">
                        <i class="pi pi-inbox"></i>
                        <span>Aucun prestataire trouvé</span>
                    </div>
                </td>
            </tr>
        </ng-template>
    </p-table>
</div>

<!-- Dialog Prévisualisation -->
<p-dialog [(visible)]="previewDialog" [style]="{ width: '800px' }" header="Prévisualisation" [modal]="true" [draggable]="false">
    <ng-template #content>
        <div class="flex flex-col gap-4" *ngIf="previewData">
            <div class="preview-summary">
                <span><strong>{{ previewData.nb_packings }}</strong> packings</span>
                <span class="preview-summary__sep"></span>
                <span><strong>{{ previewData.total_rouleaux }}</strong> rouleaux</span>
                <span class="ml-auto text-xl font-bold text-primary">{{ formatCurrency(previewData.montant_total) }}</span>
            </div>

            <p-table [value]="previewData.packings" [rows]="10" [paginator]="previewData.packings.length > 10" [rowHover]="true" styleClass="p-datatable-sm">
                <ng-template #header>
                    <tr>
                        <th>Référence</th>
                        <th>Date</th>
                        <th class="text-right">Rouleaux</th>
                        <th class="text-right">Montant</th>
                    </tr>
                </ng-template>
                <ng-template #body let-packing>
                    <tr>
                        <td class="font-medium">{{ packing.reference }}</td>
                        <td class="cell-secondary">{{ formatDateDisplay(packing.date) }}</td>
                        <td class="text-right">{{ packing.nb_rouleaux }}</td>
                        <td class="text-right font-semibold">{{ formatCurrency(packing.montant) }}</td>
                    </tr>
                </ng-template>
            </p-table>
        </div>
        <div *ngIf="previewLoading" class="flex items-center justify-center p-12">
            <i class="pi pi-spin pi-spinner text-3xl text-surface-300"></i>
        </div>
    </ng-template>
    <ng-template #footer>
        <p-button label="Fermer" [text]="true" (click)="previewDialog = false" />
    </ng-template>
</p-dialog>

<p-confirmdialog [style]="{ width: '450px' }" />
