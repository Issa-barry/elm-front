<div class="card">
    <p-toolbar styleClass="mb-12">
        <ng-template #start>
            <p-button label="Ajouter packing" icon="pi pi-plus" severity="secondary" class="mr-2" (onClick)="openNew()" />
        </ng-template>

        <ng-template #end>
            <p-button label="Export" icon="pi pi-download" severity="secondary" (onClick)="exportCSV()" />
        </ng-template>
    </p-toolbar>

    <p-table
        #dt
        [value]="packings()"
        [rows]="10"
        [columns]="cols"
        [paginator]="true"
        [globalFilterFields]="filterFields"
        [tableStyle]="{ 'min-width': '75rem' }"
        [(selection)]="selectedPackings"
        [rowHover]="true"
        dataKey="id"
        currentPageReportTemplate="Affichage {first} à {last} sur {totalRecords} packings"
        [showCurrentPageReport]="true"
        [rowsPerPageOptions]="[10, 20, 30]"
        [loading]="loading"
    >
        <ng-template #caption>
            <div class="flex items-center justify-between">
                <h5 class="m-0">Gestion des Packings</h5>
                <p-iconfield>
                    <p-inputicon styleClass="pi pi-search" />
                    <input pInputText type="text" (input)="onGlobalFilter(dt, $event)" placeholder="Rechercher..." />
                </p-iconfield>
            </div>
        </ng-template>
        <ng-template #header>
            <tr>
                <th style="width: 3rem">
                    <p-tableHeaderCheckbox />
                </th>
                <th pSortableColumn="reference" style="min-width: 10rem">
                    <span class="flex items-center gap-2">Référence
                    <p-sortIcon field="reference" /></span>
                </th>
                <th pSortableColumn="prestataire.nom" style="min-width: 14rem">
                    <span class="flex items-center gap-2">Prestataire
                    <p-sortIcon field="prestataire.nom" /></span>
                </th>
                <th style="min-width: 10rem">Phone</th>
                <th pSortableColumn="date_debut" style="min-width: 10rem">
                    <span class="flex items-center gap-2">Début
                    <p-sortIcon field="date_debut" /></span>
                </th>
                <th pSortableColumn="date_fin" style="min-width: 10rem">
                    <span class="flex items-center gap-2">Fin
                    <p-sortIcon field="date_fin" /></span>
                </th>
                <th pSortableColumn="nb_rouleaux" style="min-width: 8rem">
                    <span class="flex items-center gap-2">Rouleaux
                    <p-sortIcon field="nb_rouleaux" /></span>
                </th>
                <th pSortableColumn="montant" style="min-width: 10rem">
                    <span class="flex items-center gap-2">Montant
                    <p-sortIcon field="montant" /></span>
                </th>
                <th pSortableColumn="statut" style="min-width: 10rem">
                    <span class="flex items-center gap-2">Statut
                    <p-sortIcon field="statut" /></span>
                </th>
                <th style="min-width: 10rem"></th>
            </tr>
        </ng-template>
        <ng-template #body let-packing>
            <tr>
                <td style="width: 3rem">
                    <p-tableCheckbox [value]="packing" />
                </td>
                <td>{{ packing.reference }}</td>
                <td>
                    <span *ngIf="packing.prestataire">
                        {{ packing.prestataire.nom }} {{ packing.prestataire.prenom }}
                    </span>
                </td>
                <td>
                    <span *ngIf="packing.prestataire">{{ packing.prestataire.phone }}</span>
                </td>
                <td>{{ formatDateDisplay(packing.date_debut) }}</td>
                <td>{{ formatDateDisplay(packing.date_fin) }}</td>
                <td>{{ packing.nb_rouleaux }}</td>
                <td>{{ formatCurrency(packing.montant) }}</td>
                <td>
                    <p-tag [value]="getStatutLabel(packing.statut)" [severity]="getStatutSeverity(packing.statut)" />
                </td>
                <td>
                    <p-button icon="pi pi-pencil" class="mr-2" [rounded]="true" [outlined]="true" (click)="editPacking(packing)" />
                    <p-button icon="pi pi-trash" severity="danger" [rounded]="true" [outlined]="true" (click)="deletePacking(packing)" />
                </td>
            </tr>
        </ng-template>
    </p-table>
</div>

<p-dialog [(visible)]="packingDialog" [style]="{ width: '750px' }" header="Détails du packing" [modal]="true">
    <ng-template #content>
        <div class="flex flex-col gap-6">
            <div>
                <label for="prestataire" class="block font-bold mb-4">Prestataire (Machiniste)</label>
                <p-autoComplete
                    [(ngModel)]="selectedPrestataire"
                    [suggestions]="filteredPrestataires"
                    (completeMethod)="filterPrestataire($event)"
                    field="nom_complet"
                    [dropdown]="true"
                    [forceSelection]="true"
                    placeholder="Sélectionner un prestataire"
                    styleClass="w-full"
                />
                <small class="text-red-500" *ngIf="submitted && !selectedPrestataire">Le prestataire est requis.</small>
            </div>

            <div class="grid grid-cols-12 gap-4">
                <div class="col-span-6">
                    <label for="date_debut" class="block font-bold mb-4">Date début</label>
                    <p-datepicker
                        [(ngModel)]="packing.date_debut"
                        dateFormat="dd/mm/yy"
                        [showIcon]="true"
                        styleClass="w-full"
                    />
                </div>
                <div class="col-span-6">
                    <label for="date_fin" class="block font-bold mb-4">Date fin</label>
                    <p-datepicker
                        [(ngModel)]="packing.date_fin"
                        dateFormat="dd/mm/yy"
                        [showIcon]="true"
                        styleClass="w-full"
                    />
                </div>
            </div>

            <div class="grid grid-cols-12 gap-4">
                <div class="col-span-6">
                    <label for="nb_rouleaux" class="block font-bold mb-4">Nombre de rouleaux</label>
                    <p-inputnumber
                        id="nb_rouleaux"
                        [(ngModel)]="packing.nb_rouleaux"
                        (onInput)="calculateMontant()"
                        [min]="0"
                        styleClass="w-full"
                    />
                </div>
                <div class="col-span-6">
                    <label for="prix_rouleau" class="block font-bold mb-4">Prix du rouleau (GNF)</label>
                    <p-inputnumber
                        id="prix_rouleau"
                        [(ngModel)]="packing.prix_rouleau"
                        (onInput)="calculateMontant()"
                        [min]="0"
                        styleClass="w-full"
                    />
                </div>
            </div>

            <div class="grid grid-cols-12 gap-4">
                <div class="col-span-6">
                    <label for="montant" class="block font-bold mb-4">Montant total (GNF)</label>
                    <p-inputnumber
                        id="montant"
                        [(ngModel)]="packing.montant"
                        [min]="0"
                        styleClass="w-full"
                    />
                </div>
                <div class="col-span-6">
                    <label for="statut" class="block font-bold mb-4">Statut</label>
                    <p-select
                        [(ngModel)]="packing.statut"
                        [options]="statuses"
                        optionLabel="label"
                        optionValue="value"
                        placeholder="Sélectionner un statut"
                        styleClass="w-full"
                    />
                </div>
            </div>

            <div>
                <label for="notes" class="block font-bold mb-4">Notes</label>
                <textarea
                    pTextarea
                    id="notes"
                    [(ngModel)]="packing.notes"
                    rows="3"
                    class="w-full"
                ></textarea>
            </div>
        </div>
    </ng-template>

    <ng-template #footer>
        <p-button label="Annuler" icon="pi pi-times" text (click)="hideDialog()" />
        <p-button label="Enregistrer" icon="pi pi-check" (click)="savePacking()" />
    </ng-template>
</p-dialog>

<p-confirmdialog [style]="{ width: '450px' }" />
