<div class="packing-paiement-container p-4">
  <p-toast />
  <p-confirmDialog />

  <!-- En-tête avec statistiques -->
  <div class="mb-4">
    <h2 class="text-3xl font-bold text-surface-900 dark:text-surface-0 mb-3">
      <i class="pi pi-money-bill mr-2 text-primary"></i>
      Comptabilité - Paiements Packing
    </h2>
  </div>

  <!-- Cartes statistiques -->
  <div class="grid mb-4">
    <div class="col-12 md:col-6 lg:col-3">
      <p-card styleClass="bg-blue-50 dark:bg-blue-900/20 border-blue-200 dark:border-blue-800">
        <div class="flex justify-content-between align-items-center">
          <div>
            <div class="text-blue-600 dark:text-blue-400 font-semibold text-sm mb-2">
              TOTAL À PAYER
            </div>
            <div class="text-2xl font-bold text-blue-900 dark:text-blue-100">
              {{ formatCurrency(totalAPayer) }}
            </div>
          </div>
          <div class="bg-blue-500 text-white border-circle flex align-items-center justify-content-center"
               style="width: 3.5rem; height: 3.5rem">
            <i class="pi pi-wallet text-2xl"></i>
          </div>
        </div>
      </p-card>
    </div>

    <div class="col-12 md:col-6 lg:col-3">
      <p-card styleClass="bg-green-50 dark:bg-green-900/20 border-green-200 dark:border-green-800">
        <div class="flex justify-content-between align-items-center">
          <div>
            <div class="text-green-600 dark:text-green-400 font-semibold text-sm mb-2">
              TOTAL PAYÉ
            </div>
            <div class="text-2xl font-bold text-green-900 dark:text-green-100">
              {{ formatCurrency(totalPaye) }}
            </div>
          </div>
          <div class="bg-green-500 text-white border-circle flex align-items-center justify-content-center"
               style="width: 3.5rem; height: 3.5rem">
            <i class="pi pi-check-circle text-2xl"></i>
          </div>
        </div>
      </p-card>
    </div>

    <div class="col-12 md:col-6 lg:col-3">
      <p-card styleClass="bg-orange-50 dark:bg-orange-900/20 border-orange-200 dark:border-orange-800">
        <div class="flex justify-content-between align-items-center">
          <div>
            <div class="text-orange-600 dark:text-orange-400 font-semibold text-sm mb-2">
              RESTE À PAYER
            </div>
            <div class="text-2xl font-bold text-orange-900 dark:text-orange-100">
              {{ formatCurrency(totalRestant) }}
            </div>
          </div>
          <div class="bg-orange-500 text-white border-circle flex align-items-center justify-content-center"
               style="width: 3.5rem; height: 3.5rem">
            <i class="pi pi-exclamation-triangle text-2xl"></i>
          </div>
        </div>
      </p-card>
    </div>

    <div class="col-12 md:col-6 lg:col-3">
      <p-card styleClass="bg-red-50 dark:bg-red-900/20 border-red-200 dark:border-red-800">
        <div class="flex justify-content-between align-items-center">
          <div>
            <div class="text-red-600 dark:text-red-400 font-semibold text-sm mb-2">
              NON PAYÉS
            </div>
            <div class="text-2xl font-bold text-red-900 dark:text-red-100">
              {{ nombreNonPaye }}
            </div>
          </div>
          <div class="bg-red-500 text-white border-circle flex align-items-center justify-content-center"
               style="width: 3.5rem; height: 3.5rem">
            <i class="pi pi-times-circle text-2xl"></i>
          </div>
        </div>
      </p-card>
    </div>
  </div>

  <!-- Tableau principal -->
  <p-card>
    <p-toolbar styleClass="mb-4 border-noround">
      <div class="flex align-items-center gap-2">
        <i class="pi pi-list text-2xl text-primary"></i>
        <span class="text-xl font-semibold">Liste des Paiements</span>
      </div>

      <ng-template pTemplate="end">
        <div class="flex gap-2">
          <p-button label="PDF" 
                    icon="pi pi-file-pdf" 
                    severity="danger"
                    (onClick)="exportPDF()" />
          <p-button label="Excel" 
                    icon="pi pi-file-excel" 
                    severity="success"
                    (onClick)="exportExcel()" />
        </div>
      </ng-template>
    </p-toolbar>

    <p-table #dt
             [value]="packings"
             [loading]="loading"
             [rows]="10"
             [paginator]="true"
             [globalFilterFields]="['contact.nom', 'contact.prenom', 'contact.phone', 'reference_paiement']"
             [rowsPerPageOptions]="[10, 25, 50]"
             [showCurrentPageReport]="true"
             currentPageReportTemplate="Affichage de {first} à {last} sur {totalRecords} paiements"
             [(selection)]="selectedPackings"
             [rowHover]="true"
             dataKey="id"
             styleClass="p-datatable-sm">
      
      <ng-template pTemplate="caption">
        <div class="flex flex-column md:flex-row md:justify-content-between gap-2">
          <span class="p-input-icon-left w-full md:w-auto">
            <i class="pi pi-search"></i>
            <input pInputText 
                   type="text" 
                   [(ngModel)]="searchValue"
                   (input)="dt.filterGlobal(searchValue, 'contains')" 
                   placeholder="Rechercher..."
                   class="w-full md:w-20rem" />
          </span>
          <p-button label="Effacer" 
                    [outlined]="true"
                    icon="pi pi-filter-slash" 
                    (onClick)="clear(dt)" />
        </div>
      </ng-template>

      <ng-template pTemplate="header">
        <tr>
          <th style="width: 3rem">
            <p-tableHeaderCheckbox />
          </th>
          <th pSortableColumn="contact.nom" style="min-width: 12rem">
            Contact
            <p-sortIcon field="contact.nom" />
          </th>
          <th pSortableColumn="date_debut" style="min-width: 10rem">
            Période
            <p-sortIcon field="date_debut" />
          </th>
          <th pSortableColumn="nombre_rouleaux" class="text-right" style="min-width: 8rem">
            Rouleaux
            <p-sortIcon field="nombre_rouleaux" />
          </th>
          <th pSortableColumn="montant" class="text-right" style="min-width: 10rem">
            Montant Total
            <p-sortIcon field="montant" />
          </th>
          <th pSortableColumn="montant_paye" class="text-right" style="min-width: 10rem">
            Montant Payé
            <p-sortIcon field="montant_paye" />
          </th>
          <th pSortableColumn="montant_restant" class="text-right" style="min-width: 10rem">
            Reste à Payer
            <p-sortIcon field="montant_restant" />
          </th>
          <th pSortableColumn="statut_paiement" style="min-width: 10rem">
            Statut Paiement
            <p-sortIcon field="statut_paiement" />
          </th>
          <th style="min-width: 10rem">Actions</th>
        </tr>
      </ng-template>

      <ng-template pTemplate="body" let-packing>
        <tr>
          <td>
            <p-tableCheckbox [value]="packing" />
          </td>
          <td>
            <div class="flex flex-column">
              <span class="font-semibold text-surface-900 dark:text-surface-0">
                {{ packing.contact?.prenom }} {{ packing.contact?.nom }}
              </span>
              <span class="text-sm text-surface-600 dark:text-surface-400">
                <i class="pi pi-phone text-xs mr-1"></i>
                {{ packing.contact?.phone }}
              </span>
            </div>
          </td>
          <td>
            <div class="flex flex-column gap-1">
              <span class="text-sm">
                <i class="pi pi-calendar text-xs mr-1"></i>
                {{ formatDate(packing.date_debut) }}
              </span>
              <span class="text-sm" *ngIf="packing.date_fin">
                <i class="pi pi-calendar-times text-xs mr-1"></i>
                {{ formatDate(packing.date_fin) }}
              </span>
              <p-tag *ngIf="!packing.date_fin" 
                     value="En cours" 
                     severity="info"
                     [rounded]="true" />
            </div>
          </td>
          <td class="text-right">
            <p-chip [label]="packing.nombre_rouleaux?.toString() || '0'" 
                    icon="pi pi-box"
                    styleClass="bg-primary-50 dark:bg-primary-900/20 text-primary-900 dark:text-primary-100" />
          </td>
          <td class="text-right">
            <span class="font-semibold text-surface-900 dark:text-surface-0">
              {{ formatCurrency(packing.montant) }}
            </span>
          </td>
          <td class="text-right">
            <span class="font-semibold text-green-600 dark:text-green-400">
              {{ formatCurrency(packing.montant_paye) }}
            </span>
          </td>
          <td class="text-right">
            <span class="font-semibold"
                  [ngClass]="{
                    'text-green-600 dark:text-green-400': packing.montant_restant === 0,
                    'text-orange-600 dark:text-orange-400': packing.montant_restant && packing.montant_restant > 0
                  }">
              {{ formatCurrency(packing.montant_restant) }}
            </span>
          </td>
          <td>
            <p-tag [value]="packing.statut_paiement === 'paye' ? 'Payé' : 
                            packing.statut_paiement === 'partiel' ? 'Partiel' : 'Non Payé'"
                   [severity]="getPaiementSeverity(packing.statut_paiement)"
                   [rounded]="true" />
          </td>
          <td>
            <div class="flex gap-2">
              <p-button icon="pi pi-eye" 
                        [rounded]="true"
                        [text]="true"
                        severity="info"
                        pTooltip="Voir détails"
                        tooltipPosition="top"
                        (onClick)="openDetailsDialog(packing)" />
              <p-button icon="pi pi-money-bill" 
                        [rounded]="true"
                        [text]="true"
                        severity="success"
                        pTooltip="Enregistrer paiement"
                        tooltipPosition="top"
                        [disabled]="packing.statut_paiement === 'paye'"
                        (onClick)="openPaiementDialog(packing)" />
            </div>
          </td>
        </tr>
      </ng-template>

      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="9" class="text-center py-5">
            <div class="flex flex-column align-items-center gap-3">
              <i class="pi pi-inbox text-6xl text-surface-400"></i>
              <p class="text-xl text-surface-600 dark:text-surface-400 m-0">
                Aucun paiement trouvé
              </p>
            </div>
          </td>
        </tr>
      </ng-template>

      <ng-template pTemplate="loadingbody">
        <tr>
          <td colspan="9">
            <div class="flex flex-column gap-2 p-3">
              <p-skeleton width="100%" height="2rem" />
              <p-skeleton width="100%" height="2rem" />
              <p-skeleton width="100%" height="2rem" />
            </div>
          </td>
        </tr>
      </ng-template>
    </p-table>
  </p-card>

  <!-- Dialog Enregistrement Paiement -->
  <p-dialog header="Enregistrer un Paiement" 
            [(visible)]="displayPaiementDialog"
            [modal]="true"
            [style]="{ width: '90vw', 'max-width': '500px' }"
            [draggable]="false"
            [resizable]="false">
    <div class="flex flex-column gap-4" *ngIf="packingSelectionne">
      <!-- Info Contact -->
      <div class="p-3 surface-50 dark:surface-800 border-round">
        <div class="flex align-items-center gap-2 mb-2">
          <i class="pi pi-user text-primary"></i>
          <span class="font-semibold">
            {{ packingSelectionne.contact?.prenom }} {{ packingSelectionne.contact?.nom }}
          </span>
        </div>
        <div class="text-sm text-surface-600 dark:text-surface-400">
          <i class="pi pi-phone text-xs mr-1"></i>
          {{ packingSelectionne.contact?.phone }}
        </div>
      </div>

      <!-- Résumé Packing -->
      <div class="grid">
        <div class="col-6">
          <div class="text-sm text-surface-600 dark:text-surface-400 mb-1">
            Nombre de rouleaux
          </div>
          <div class="font-semibold">{{ packingSelectionne.nombre_rouleaux }}</div>
        </div>
        <div class="col-6">
          <div class="text-sm text-surface-600 dark:text-surface-400 mb-1">
            Montant total
          </div>
          <div class="font-semibold text-surface-900 dark:text-surface-0">
            {{ formatCurrency(packingSelectionne.montant) }}
          </div>
        </div>
        <div class="col-6">
          <div class="text-sm text-surface-600 dark:text-surface-400 mb-1">
            Déjà payé
          </div>
          <div class="font-semibold text-green-600 dark:text-green-400">
            {{ formatCurrency(packingSelectionne.montant_paye) }}
          </div>
        </div>
        <div class="col-6">
          <div class="text-sm text-surface-600 dark:text-surface-400 mb-1">
            Reste à payer
          </div>
          <div class="font-semibold text-orange-600 dark:text-orange-400">
            {{ formatCurrency(packingSelectionne.montant_restant) }}
          </div>
        </div>
      </div>

      <p-divider />

      <!-- Formulaire Paiement -->
      <div class="field">
        <p-floatLabel>
          <p-inputNumber id="montantPaiement"
                         inputId="montantPaiement"
                         [(ngModel)]="montantPaiement"
                         mode="currency"
                         currency="GNF"
                         locale="fr-GN"
                         [min]="0"
                         [max]="packingSelectionne.montant_restant || 0"
                         [minFractionDigits]="0"
                         styleClass="w-full" />
          <label for="montantPaiement">
            Montant du paiement <span class="text-red-500">*</span>
          </label>
        </p-floatLabel>
      </div>

      <div class="field">
        <p-floatLabel>
          <p-datePicker id="datePaiement"
                        inputId="datePaiement"
                        [(ngModel)]="datePaiement"
                        dateFormat="dd/mm/yy"
                        [showIcon]="true"
                        styleClass="w-full" />
          <label for="datePaiement">
            Date de paiement <span class="text-red-500">*</span>
          </label>
        </p-floatLabel>
      </div>

      <div class="field">
        <p-floatLabel>
          <p-select id="modePaiement"
                    inputId="modePaiement"
                    [(ngModel)]="modePaiementSelectionne"
                    [options]="modesPaiement"
                    optionLabel="name"
                    placeholder="Sélectionner un mode de paiement"
                    styleClass="w-full" />
          <label for="modePaiement">
            Mode de paiement <span class="text-red-500">*</span>
          </label>
        </p-floatLabel>
      </div>

      <div class="field">
        <p-floatLabel>
          <input pInputText 
                 id="referencePaiement" 
                 [(ngModel)]="referencePaiement"
                 class="w-full" />
          <label for="referencePaiement">
            Référence du paiement
          </label>
        </p-floatLabel>
        <small class="text-surface-500">
          Optionnel - Ex: numéro de transaction, numéro de chèque, etc.
        </small>
      </div>
    </div>

    <ng-template pTemplate="footer">
      <div class="flex gap-2 justify-content-end">
        <p-button label="Annuler" 
                  severity="secondary"
                  [outlined]="true"
                  (onClick)="displayPaiementDialog = false" />
        <p-button label="Enregistrer" 
                  icon="pi pi-check"
                  (onClick)="enregistrerPaiement()" />
      </div>
    </ng-template>
  </p-dialog>

  <!-- Dialog Détails -->
  <p-dialog header="Détails du Paiement" 
            [(visible)]="displayDetailsDialog"
            [modal]="true"
            [style]="{ width: '90vw', 'max-width': '600px' }"
            [draggable]="false"
            [resizable]="false">
    <div class="flex flex-column gap-4" *ngIf="packingSelectionne">
      <!-- Info Contact -->
      <div>
        <h3 class="text-lg font-semibold mb-3">
          <i class="pi pi-user mr-2 text-primary"></i>
          Informations du Contact
        </h3>
        <div class="p-3 surface-50 dark:surface-800 border-round">
          <div class="grid">
            <div class="col-6">
              <div class="text-sm text-surface-600 dark:text-surface-400 mb-1">Nom complet</div>
              <div class="font-semibold">
                {{ packingSelectionne.contact?.prenom }} {{ packingSelectionne.contact?.nom }}
              </div>
            </div>
            <div class="col-6">
              <div class="text-sm text-surface-600 dark:text-surface-400 mb-1">Téléphone</div>
              <div class="font-semibold">{{ packingSelectionne.contact?.phone }}</div>
            </div>
          </div>
        </div>
      </div>

      <p-divider />

      <!-- Info Packing -->
      <div>
        <h3 class="text-lg font-semibold mb-3">
          <i class="pi pi-box mr-2 text-primary"></i>
          Détails du Packing
        </h3>
        <div class="grid">
          <div class="col-6">
            <div class="text-sm text-surface-600 dark:text-surface-400 mb-1">Date début</div>
            <div class="font-semibold">{{ formatDate(packingSelectionne.date_debut) }}</div>
          </div>
          <div class="col-6">
            <div class="text-sm text-surface-600 dark:text-surface-400 mb-1">Date fin</div>
            <div class="font-semibold">
              {{ formatDate(packingSelectionne.date_fin) }}
            </div>
          </div>
          <div class="col-6">
            <div class="text-sm text-surface-600 dark:text-surface-400 mb-1">Nombre de rouleaux</div>
            <div class="font-semibold">{{ packingSelectionne.nombre_rouleaux }}</div>
          </div>
          <div class="col-6">
            <div class="text-sm text-surface-600 dark:text-surface-400 mb-1">Prix unitaire</div>
            <div class="font-semibold">{{ formatCurrency(packingSelectionne.prix_rouleau) }}</div>
          </div>
        </div>
      </div>

      <p-divider />

      <!-- Info Paiement -->
      <div>
        <h3 class="text-lg font-semibold mb-3">
          <i class="pi pi-money-bill mr-2 text-primary"></i>
          Informations de Paiement
        </h3>
        <div class="grid">
          <div class="col-6">
            <div class="text-sm text-surface-600 dark:text-surface-400 mb-1">Montant total</div>
            <div class="font-semibold text-lg">{{ formatCurrency(packingSelectionne.montant) }}</div>
          </div>
          <div class="col-6">
            <div class="text-sm text-surface-600 dark:text-surface-400 mb-1">Statut</div>
            <div>
              <p-tag [value]="packingSelectionne.statut_paiement === 'paye' ? 'Payé' : 
                              packingSelectionne.statut_paiement === 'partiel' ? 'Partiel' : 'Non Payé'"
                     [severity]="getPaiementSeverity(packingSelectionne.statut_paiement)" />
            </div>
          </div>
          <div class="col-6">
            <div class="text-sm text-surface-600 dark:text-surface-400 mb-1">Montant payé</div>
            <div class="font-semibold text-green-600 dark:text-green-400">
              {{ formatCurrency(packingSelectionne.montant_paye) }}
            </div>
          </div>
          <div class="col-6">
            <div class="text-sm text-surface-600 dark:text-surface-400 mb-1">Reste à payer</div>
            <div class="font-semibold text-orange-600 dark:text-orange-400">
              {{ formatCurrency(packingSelectionne.montant_restant) }}
            </div>
          </div>
          <div class="col-6" *ngIf="packingSelectionne.date_paiement">
            <div class="text-sm text-surface-600 dark:text-surface-400 mb-1">Date de paiement</div>
            <div class="font-semibold">{{ formatDate(packingSelectionne.date_paiement) }}</div>
          </div>
          <div class="col-6" *ngIf="packingSelectionne.mode_paiement">
            <div class="text-sm text-surface-600 dark:text-surface-400 mb-1">Mode de paiement</div>
            <div class="font-semibold">{{ packingSelectionne.mode_paiement }}</div>
          </div>
          <div class="col-12" *ngIf="packingSelectionne.reference_paiement">
            <div class="text-sm text-surface-600 dark:text-surface-400 mb-1">Référence</div>
            <div class="font-semibold">{{ packingSelectionne.reference_paiement }}</div>
          </div>
        </div>
      </div>
    </div>

    <ng-template pTemplate="footer">
      <div class="flex gap-2 justify-content-end">
        <p-button label="Imprimer Reçu" 
                  icon="pi pi-print"
                  severity="secondary"
                  [outlined]="true"
                  (onClick)="imprimerRecu(packingSelectionne!)" />
        <p-button label="Fermer" 
                  (onClick)="displayDetailsDialog = false" />
      </div>
    </ng-template>
  </p-dialog>
</div>