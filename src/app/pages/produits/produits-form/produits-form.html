<div class="card">
    <div class="flex justify-between items-center mb-6">
        <span class="text-surface-900 dark:text-surface-0 text-xl font-bold">
            {{ mode === 'create' ? 'Créer un produit' : 'Détails du produit' }}
        </span>
        
        <!-- Bouton Modifier -->
        <button
            *ngIf="mode === 'edit' && !isEditing"
            pButton
            pRipple
            label="Modifier"
            icon="pi pi-pencil"
            severity="warn"
            (click)="enableEditing()"
            class="w-auto">
        </button>
    </div>

    <p-fluid class="grid grid-cols-12 gap-4 flex-wrap">
        <div class="col-span-12 lg:col-span-8">
            <div class="grid grid-cols-12 gap-4">
                
                <!-- Type de produit -->
                <div class="col-span-12">
                    <label class="mb-3 text-surface-900 dark:text-surface-0 font-bold block">
                        Type de produit <span class="text-red-500" *ngIf="isEditing">*</span>
                    </label>
                    <p-select 
                        [options]="typeOptions" 
                        [(ngModel)]="product.type" 
                        optionLabel="label"
                        optionValue="value"
                        placeholder="Sélectionner le type" 
                        (onChange)="onTypeChange()"
                        [disabled]="fieldsDisabled"
                        [invalid]="submitted && !product.type"
                        fluid>
                    </p-select>
                    <small class="text-red-500" *ngIf="submitted && !product.type && isEditing">
                        Type de produit obligatoire.
                    </small>
                    <small class="text-blue-600 block mt-1" *ngIf="product.type && isEditing">
                        <i class="pi pi-info-circle mr-1"></i>{{ getPrixHelperText() }}
                    </small>
                </div> 
                
                <!-- Nom du produit -->
                <div class="col-span-12 mb-3">
                    <label for="nom" class="font-medium text-surface-900 dark:text-surface-0 mb-2 block">
                        Nom du produit <span class="text-red-500" *ngIf="isEditing">*</span>
                    </label>
                    <input 
                        id="nom"
                        pInputText 
                        type="text" 
                        placeholder="Ex: iPhone 15 Pro" 
                        [(ngModel)]="product.nom"
                        [disabled]="fieldsDisabled"
                        [invalid]="submitted && !product.nom?.trim()"
                        fluid />
                    <small class="text-red-500" *ngIf="submitted && !product.nom?.trim() && isEditing">
                        Nom du produit obligatoire.
                    </small>
                </div>

                <!-- Prix usine (Fabricable uniquement) -->
                <div class="col-span-12 lg:col-span-4" *ngIf="isPrixUsineVisible()">
                    <label for="prix_usine" class="font-medium text-surface-900 dark:text-surface-0 mb-2 block">
                        Prix usine (GNF) <span class="text-red-500" *ngIf="isEditing && isPrixUsineRequired()">*</span>
                    </label>
                    <p-inputnumber
                        inputId="prix_usine"
                        [(ngModel)]="product.prix_usine"
                        mode="currency"
                        currency="GNF"
                        locale="fr-GN"
                        [disabled]="fieldsDisabled"
                        [invalid]="submitted && isPrixUsineRequired() && !product.prix_usine"
                        placeholder="0"
                        fluid>
                    </p-inputnumber>
                    <small class="text-red-500" *ngIf="submitted && isPrixUsineRequired() && !product.prix_usine && isEditing">
                        Prix usine obligatoire pour "Fabricable".
                    </small>
                </div>

                <!-- Prix achat (Matériel, Achat/Vente) -->
                <div class="col-span-12" [ngClass]="isPrixUsineVisible() ? 'lg:col-span-4' : 'lg:col-span-6'" *ngIf="isPrixAchatVisible()">
                    <label for="prix_achat" class="font-medium text-surface-900 dark:text-surface-0 mb-2 block">
                        Prix achat (GNF) <span class="text-red-500" *ngIf="isEditing && isPrixAchatRequired()">*</span>
                    </label>
                    <p-inputnumber
                        inputId="prix_achat"
                        [(ngModel)]="product.prix_achat"
                        mode="currency"
                        currency="GNF"
                        locale="fr-GN"
                        [disabled]="fieldsDisabled"
                        [invalid]="submitted && isPrixAchatRequired() && !product.prix_achat"
                        placeholder="0"
                        fluid>
                    </p-inputnumber>
                    <small class="text-red-500" *ngIf="submitted && isPrixAchatRequired() && !product.prix_achat && isEditing">
                        Prix d'achat obligatoire pour ce type.
                    </small>
                </div>

                <!-- Prix vente (Service, Fabricable, Achat/Vente) -->
                <div class="col-span-12" [ngClass]="isPrixUsineVisible() ? 'lg:col-span-4' : 'lg:col-span-6'" *ngIf="isPrixVenteVisible()">
                    <label for="prix_vente" class="font-medium text-surface-900 dark:text-surface-0 mb-2 block">
                        Prix vente (GNF) <span class="text-red-500" *ngIf="isEditing && isPrixVenteRequired()">*</span>
                    </label>
                    <p-inputnumber
                        inputId="prix_vente"
                        [(ngModel)]="product.prix_vente"
                        mode="currency"
                        currency="GNF"
                        locale="fr-GN"
                        [disabled]="fieldsDisabled"
                        [invalid]="submitted && isPrixVenteRequired() && !product.prix_vente"
                        placeholder="0"
                        fluid>
                    </p-inputnumber>
                    <small class="text-red-500" *ngIf="submitted && isPrixVenteRequired() && !product.prix_vente && isEditing">
                        Prix de vente obligatoire pour ce type.
                    </small>
                </div>

                <!-- Upload image -->
                <div class="col-span-12 mt-4" *ngIf="isEditing">
                    <label class="font-medium text-surface-900 dark:text-surface-0 mb-2 block">
                        Image du produit
                    </label>
                    <p-fileUpload
                        #fileUploader
                        name="image"
                        (onSelect)="onUpload($event)"
                        [customUpload]="true"
                        [multiple]="false"
                        accept="image/*"
                        [showUploadButton]="false"
                        [showCancelButton]="false"
                        [auto]="true"
                        [disabled]="fieldsDisabled"
                        styleClass="border border-surface-200 dark:border-surface-700 bg-surface-0 dark:bg-surface-900 p-0 rounded">
                        <ng-template #content>
                            <div class="w-full py-4" style="cursor: pointer" (click)="!fieldsDisabled && fileUploader.advancedFileInput.nativeElement.click()">
                                <!-- Aucune image -->
                                <div *ngIf="!imagePreview && !product.image_url" class="h-40 flex flex-col justify-center items-center">
                                    <i class="pi pi-image text-primary text-4xl mb-4"></i>
                                    <span class="block font-semibold text-surface-900 dark:text-surface-0 text-lg">Ajouter une image</span>
                                    <span class="text-surface-500 text-sm mt-1">Cliquez pour sélectionner</span>
                                </div>
                                <!-- Image existante ou preview -->
                                <div *ngIf="imagePreview || product.image_url" class="relative w-full flex justify-center">
                                    <div class="relative">
                                        <img
                                            [src]="imagePreview || product.getImageUrl()"
                                            alt="Image du produit"
                                            class="max-h-60 rounded shadow object-contain" />
                                        <button
                                            *ngIf="!fieldsDisabled"
                                            pButton
                                            pRipple
                                            rounded
                                            type="button"
                                            severity="danger"
                                            class="absolute -top-2 -right-2"
                                            (click)="removeImage($event)">
                                            <i class="pi pi-times"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </ng-template>
                    </p-fileUpload>
                </div>

                <!-- Affichage de l'image en mode lecture -->
                <div class="col-span-12 mt-4" *ngIf="!isEditing && product.image_url">
                    <label class="font-medium text-surface-900 dark:text-surface-0 mb-2 block">
                        Image du produit
                    </label>
                    <div class="flex justify-center">
                        <img [src]="product.getImageUrl()" alt="Image du produit" class="max-h-60 rounded shadow object-contain" />
                    </div>
                </div>
                
            </div>
        </div>

        <!-- Sidebar droite -->
        <div class="col-span-12 lg:col-span-4 flex flex-col gap-y-4 mt-8">
            <!-- Statut (uniquement en mode édition) -->
            <div class="border border-surface-200 dark:border-surface-700 rounded" *ngIf="mode === 'edit'">
                <span class="text-surface-900 dark:text-surface-0 font-bold block border-b border-surface-200 dark:border-surface-700 p-4">
                    Statut
                </span>
                <div class="p-4">
                    <div class="bg-surface-100 dark:bg-surface-700 py-2 px-4 flex items-center rounded">
                        <span class="text-black/90 dark:text-surface-0 font-bold mr-4">Statut:</span>
                        <span class="text-black/60 dark:text-surface-0 font-semibold">{{ product.statut }}</span>
                    </div>
                </div>
            </div>

            <!-- En stock -->
            <div class="border border-surface-200 dark:border-surface-700 flex justify-between items-center px-4 rounded">
                <span class="text-surface-900 dark:text-surface-0 font-bold p-4">En stock</span>
                <p-toggleswitch [(ngModel)]="product.in_stock" [disabled]="fieldsDisabled"></p-toggleswitch>
            </div>

            <!-- Quantité en stock -->
            <div class="border border-surface-200 dark:border-surface-700 rounded">
                <span class="text-surface-900 dark:text-surface-0 font-bold block border-b border-surface-200 dark:border-surface-700 p-4">
                    Quantité en stock
                    <span class="text-sm font-normal text-gray-500" *ngIf="product.type === 'service'">
                        (non applicable)
                    </span>
                </span>
                <div class="p-4">
                    <div class="bg-surface-100 dark:bg-surface-700 py-2 px-4 flex items-center rounded">
                        <p-inputnumber
                            [(ngModel)]="product.qte_stock"
                            [showButtons]="true"
                            [min]="0"
                            [disabled]="isQteStockDisabled()"
                            placeholder="0"
                            fluid>
                        </p-inputnumber>
                    </div>
                    <small class="text-gray-500 block mt-2" *ngIf="product.type === 'service'">
                        <i class="pi pi-info-circle mr-1"></i>Le stock n'est pas géré pour les services.
                    </small>
                </div>
            </div>

            <!-- Boutons d'action -->
            <div class="flex gap-2" *ngIf="isEditing">
                <button 
                    pButton 
                    pRipple 
                    [label]="mode === 'create' ? 'Enregistrer' : 'Sauvegarder'"
                    icon="pi pi-check"
                    (click)="onSubmit()"
                    [loading]="loading"
                    [disabled]="!isValid() || loading"
                    class="flex-1">
                </button>
                <button 
                    pButton 
                    pRipple 
                    label="Annuler"
                    icon="pi pi-times"
                    severity="secondary"
                    (click)="mode === 'create' ? onCancel() : cancelEditing()"
                    [disabled]="loading"
                    class="flex-1">
                </button>
            </div>
        </div>
    </p-fluid>
</div> 