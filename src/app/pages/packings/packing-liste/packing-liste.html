<p-toast />

<div class="card">
    <p-toolbar styleClass="mb-12">
        <ng-template #start>
            <p-button label="Ajouter packing" icon="pi pi-plus" severity="secondary" class="mr-2" (onClick)="openNew()" />
        </ng-template>

        <ng-template #end>
            <div class="flex items-center gap-2">
                <p-select
                    [(ngModel)]="filterStatut"
                    [options]="statuses"
                    optionLabel="label"
                    optionValue="value"
                    placeholder="Statut"
                    [showClear]="true"
                    (onChange)="onDateFilter()"
                    styleClass="w-40"
                />
                <p-datepicker
                    [(ngModel)]="filterDateRange"
                    selectionMode="range"
                    dateFormat="dd/mm/yy"
                    placeholder="Période"
                    [showIcon]="true"
                    (onSelect)="onDateRangeSelect()"
                    inputStyleClass="w-full"
                    styleClass="w-56"
                    [readonlyInput]="true"
                />
                <p-button
                    icon="pi pi-filter-slash"
                    severity="secondary"
                    [outlined]="true"
                    [rounded]="true"
                    (onClick)="clearDateFilters()"
                    *ngIf="filterDateRange || filterStatut"
                    pTooltip="Effacer les filtres"
                />
                <p-button label="Export" icon="pi pi-download" severity="secondary" (onClick)="exportCSV()" />
            </div>
        </ng-template>
    </p-toolbar>

    <p-table
        #dt
        [value]="packings()"
        [rows]="10"
        [columns]="cols"
        [paginator]="true"
        [globalFilterFields]="filterFields"
        [tableStyle]="{ 'min-width': '65rem' }"
        [(selection)]="selectedPackings"
        [rowHover]="true"
        dataKey="id"
        currentPageReportTemplate="  {first} à {last} sur {totalRecords} packings"
        [showCurrentPageReport]="true"
        [rowsPerPageOptions]="[10, 20, 30]"
        [loading]="loading"
    >
        <ng-template #caption>
            <div class="flex items-center justify-between">
                <h5 class="m-0">Gestion des Packings</h5>
                <p-iconfield>
                    <p-inputicon styleClass="pi pi-search" />
                    <input pInputText type="text" (input)="onGlobalFilter(dt, $event)" placeholder="Rechercher..." />
                </p-iconfield>
            </div>
        </ng-template>

        <ng-template #header>
            <tr>
                <th pSortableColumn="prestataire.nom">
                    <span class="col-header">Prestataire <p-sortIcon field="prestataire.nom" /></span>
                </th>
                <th><span class="col-header">Téléphone</span></th>
                <th pSortableColumn="date">
                    <span class="col-header">Date <p-sortIcon field="date" /></span>
                </th>
                <th pSortableColumn="nb_rouleaux" class="text-right">
                    <span class="col-header justify-end">Rouleaux <p-sortIcon field="nb_rouleaux" /></span>
                </th>
                <th pSortableColumn="montant" class="text-right">
                    <span class="col-header justify-end">Montant <p-sortIcon field="montant" /></span>
                </th>
                <th pSortableColumn="statut" class="text-center">
                    <span class="col-header justify-center">Statut <p-sortIcon field="statut" /></span>
                </th>
                <th class="text-center" style="width: 5rem"></th>
            </tr>
        </ng-template>

        <ng-template #body let-packing>
            <tr class="table-row" (dblclick)="editPacking(packing)">
                <td>
                    <div class="cell-prestataire" *ngIf="packing.prestataire">
                        <span class="cell-prestataire__avatar" [style.background]="'var(--p-primary-50)'" [style.color]="'var(--p-primary-600)'">
                            {{ packing.prestataire.nom?.charAt(0)?.toUpperCase() }}
                        </span>
                        <span class="cell-prestataire__name">{{ packing.prestataire.nom }} {{ packing.prestataire.prenom }}</span>
                    </div>
                </td>
                <td class="cell-secondary cell-bold">
                    <span *ngIf="packing.prestataire">{{ packing.prestataire.phone | phoneFormat:'INT' }}</span>
                </td>

                <td class="cell-secondary cell-bold">{{ formatDateDisplay(packing.date) }}</td>

                <td class="text-right cell-mono cell-bold">{{ packing.nb_rouleaux }}</td>

                <td class="text-right cell-mono cell-bold">{{ formatCurrency(packing.montant) }}</td>
                <td class="text-center">
                    <span class="status-badge" [ngClass]="{
                        'status-badge--warn': packing.statut === 'a_valider',
                        'status-badge--success': packing.statut === 'valide',
                        'status-badge--danger': packing.statut === 'annule'
                    }">
                        {{ getStatutLabel(packing.statut) }}
                    </span>
                </td>
                <td class="text-center">
                    <p-button icon="pi pi-arrow-right" severity="secondary" [text]="true" [rounded]="true" pTooltip="Modifier" (click)="editPacking(packing)" />
                </td>
            </tr>
        </ng-template>

        <ng-template #emptymessage>
            <tr>
                <td colspan="7">
                    <div class="empty-state">
                        <i class="pi pi-inbox"></i>
                        <span>Aucun packing trouvé</span>
                    </div>
                </td>
            </tr>
        </ng-template>
    </p-table>
</div>

<p-dialog [(visible)]="packingDialog" [style]="{ width: '750px' }" [header]="packing?.id ? 'Détails du packing' : 'Nouveau packing'" [modal]="true">
    <ng-template #content>
        <div class="flex flex-col gap-6">
            <!-- Prestataire -->
            <div>
                <label for="prestataire" class="block font-bold mb-4">Prestataire (Machiniste)</label>
                <p-skeleton *ngIf="dialogLoading" height="2.6rem" styleClass="w-full" />
                <p-select *ngIf="!dialogLoading"
                    [(ngModel)]="selectedPrestataire"
                    [options]="prestataires"
                    optionLabel="nom"
                    [filter]="true"
                    filterBy="nom,prenom,phone"
                    placeholder="Sélectionner un prestataire"
                    styleClass="w-full"
                >
                    <ng-template let-prestataire pTemplate="item">
                        <div class="flex items-center gap-2">
                            <i class="pi pi-user text-primary"></i>
                            <span>{{ prestataire.prenom }} {{ prestataire.nom }} - {{ prestataire.phone }}</span>
                        </div>
                    </ng-template>
                    <ng-template let-prestataire pTemplate="selectedItem">
                        <div class="flex items-center gap-2" *ngIf="prestataire">
                            <i class="pi pi-user text-primary"></i>
                            <span>{{ prestataire.prenom }} {{ prestataire.nom }}</span>
                        </div>
                    </ng-template>
                </p-select>
                <small class="text-red-500" *ngIf="submitted && !selectedPrestataire && !dialogLoading">Le prestataire est requis.</small>
            </div>

            <!-- Date -->
            <div>
                <label for="date" class="block font-bold mb-4">Date</label>
                <p-datepicker
                    [(ngModel)]="packing.date"
                    dateFormat="dd/mm/yy"
                    [showIcon]="true"
                    inputStyleClass="w-full"
                    styleClass="w-full"
                />
            </div>

            <!-- Rouleaux & Prix -->
            <div class="grid grid-cols-12 gap-4">
                <div class="col-span-6">
                    <label for="nb_rouleaux" class="block font-bold mb-4">Nombre de rouleaux</label>
                    <p-inputnumber
                        id="nb_rouleaux"
                        [(ngModel)]="packing.nb_rouleaux"
                        (onInput)="calculateMontant()"
                        [min]="0"
                        styleClass="w-full"
                    />
                </div>
                <div class="col-span-6">
                    <label for="prix_par_rouleau" class="block font-bold mb-4">Prix du rouleau (GNF)</label>
                    <p-skeleton *ngIf="dialogLoading" height="2.6rem" styleClass="w-full" />
                    <p-inputnumber *ngIf="!dialogLoading"
                        id="prix_par_rouleau"
                        [(ngModel)]="packing.prix_par_rouleau"
                        (onInput)="calculateMontant()"
                        [min]="0"
                        styleClass="w-full"
                    />
                </div>
            </div>

            <!-- Statut -->
            <div>
                <label for="statut" class="block font-bold mb-4">Statut</label>
                <p-select
                    [(ngModel)]="packing.statut"
                    [options]="statuses"
                    optionLabel="label"
                    optionValue="value"
                    placeholder="Sélectionner un statut"
                    styleClass="w-full"
                />
            </div>

            <!-- Montant total -->
            <div class="flex justify-between items-center p-4 mt-4 bg-surface-100 rounded-lg">
                <span class="font-bold text-lg">Montant total</span>
                <span class="text-2xl font-semibold text-primary">{{ formatCurrency(packing.montant || 0) }}</span>
            </div>
        </div>
    </ng-template>

    <ng-template #footer class="mt-4">
        <p-button class="mt-4" label="Annuler" icon="pi pi-times" text (click)="hideDialog()" [disabled]="saving" />
        <p-button
            class="mt-4"
            label="Enregistrer"
            icon="pi pi-check"
            (click)="savePacking()"
            [disabled]="saving || dialogLoading"
            [loading]="saving" />
    </ng-template>
</p-dialog>

<p-confirmdialog [style]="{ width: '450px' }" />

