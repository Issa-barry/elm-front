<p-toast />

<!-- Mobile: app-like list (≤768px) -->
<div class="packing-mobile-app">
  <header class="mobile-header">
    <button
      pButton
      pRipple
      icon="pi pi-arrow-left"
      class="p-button-rounded p-button-text mobile-back"
      aria-label="Retour à l'accueil"
      (click)="goHome()"
    ></button>
    <div class="mobile-title-wrap">
      <h1 class="mobile-title">Packings</h1>
      <p class="mobile-subtitle">{{ mobileFilteredPackings.length }} packing{{ mobileFilteredPackings.length !== 1 ? 's' : '' }}</p>
    </div>
    <p-menu
      #statusMenu
      [model]="mobileStatusMenuItems"
      [popup]="true"
      appendTo="body"
      styleClass="mobile-status-menu"
    />
    <button
      pButton
      pRipple
      icon="pi pi-filter"
      class="p-button-rounded p-button-text mobile-add"
      aria-label="Filtrer par statut"
      (click)="statusMenu.toggle($event)"
    ></button>
  </header>

  <div class="mobile-scroll">
    <section class="mobile-search">
      <p-iconfield>
        <p-inputicon styleClass="pi pi-search" />
        <input
          pInputText
          type="text"
          [(ngModel)]="mobileSearchTerm"
          (ngModelChange)="onMobileSearchChange()"
          placeholder="Prestataire, référence..."
          class="w-full"
        />
      </p-iconfield>
    </section>

    <section class="mobile-list" *ngIf="!loading && mobileVisiblePackings.length; else mobileListState">
      <article
        class="mobile-packing-card"
        *ngFor="let packing of mobileVisiblePackings; trackBy: trackByPackingId"
        (click)="canUpdate && editPacking(packing)"
      >
        <div class="mobile-card-avatar" aria-hidden="true" *ngIf="packing.prestataire">
          {{ getPrestataireInitials(packing.prestataire) }}
        </div>
        <div class="mobile-card-avatar mobile-card-avatar--fallback" *ngIf="!packing.prestataire" aria-hidden="true">?</div>
        <div class="mobile-card-body">
          <div class="mobile-card-name">{{ packing.prestataire ? packing.prestataire.prenom + ' ' + packing.prestataire.nom : packing.reference || 'Packing' }}</div>
          <div class="mobile-card-meta">{{ formatDateDisplay(packing.date) }} · {{ packing.nb_rouleaux }} rouleaux</div>
          <div class="mobile-card-footer">
            <span class="mobile-card-summary">{{ formatCurrency(packing.montant) }}</span>
            <span
              class="mobile-status-badge"
              [ngClass]="{
                'mobile-status-badge--warn': packing.statut === 'a_valider',
                'mobile-status-badge--success': packing.statut === 'valide',
                'mobile-status-badge--danger': packing.statut === 'annule'
              }"
            >{{ getStatutLabel(packing.statut) }}</span>
            <button
              *ngIf="canUpdate"
              pButton
              pRipple
              icon="pi pi-arrow-right"
              class="p-button-rounded p-button-text p-button-sm mobile-action-btn"
              pTooltip="Modifier"
              tooltipPosition="top"
              (click)="$event.stopPropagation(); editPacking(packing)"
            ></button>
          </div>
        </div>
      </article>
    </section>

    <ng-template #mobileListState>
      <div class="mobile-state" *ngIf="loading">Chargement...</div>
      <div class="mobile-state" *ngIf="!loading && !mobileFilteredPackings.length">Aucun packing.</div>
    </ng-template>

    <div class="mobile-load-more" *ngIf="!loading && canLoadMoreMobile">
      <button pButton label="Charger plus" icon="pi pi-angle-down" class="mobile-load-more-btn" (click)="loadMoreMobile()"></button>
    </div>
  </div>

  <button
    *ngIf="canCreate"
    type="button"
    class="mobile-fab"
    aria-label="Nouveau packing"
    (click)="openNew()"
  >
    <i class="pi pi-plus"></i>
  </button>
</div>

<!-- Desktop: toolbar + table -->
<div class="card packing-desktop">
    <p-toolbar styleClass="mb-12">
        <ng-template #start>
            <p-button *ngIf="canCreate" label="Ajouter packing" icon="pi pi-plus" severity="secondary" class="mr-2" (onClick)="openNew()" />
        </ng-template>

        <ng-template #end>
            <div class="flex items-center gap-2">
                <p-select
                    [(ngModel)]="filterStatut"
                    [options]="statuses"
                    optionLabel="label"
                    optionValue="value"
                    placeholder="Statut"
                    [showClear]="true"
                    (onChange)="onDateFilter()"
                    styleClass="w-40"
                />
                <p-datepicker
                    [(ngModel)]="filterDateRange" 
                    selectionMode="range"
                    dateFormat="dd/mm/yy"
                    placeholder="Période"
                    [showIcon]="true"
                    (onSelect)="onDateRangeSelect()"
                    inputStyleClass="w-full"
                    styleClass="w-56"
                    [readonlyInput]="true"
                />
                <p-button
                    icon="pi pi-filter-slash"
                    severity="secondary"
                    [outlined]="true"
                    [rounded]="true"
                    (onClick)="clearDateFilters()"
                    *ngIf="filterDateRange || filterStatut"
                    pTooltip="Effacer les filtres"
                />
                <p-button label="Export" icon="pi pi-download" severity="secondary" (onClick)="exportCSV()" />
            </div>
        </ng-template>
    </p-toolbar>

    <p-table
        #dt
        [value]="packings()"
        [rows]="10"
        [columns]="cols"
        [paginator]="true"
        [globalFilterFields]="filterFields"
        [tableStyle]="{ 'min-width': '65rem' }"
        [(selection)]="selectedPackings"
        [rowHover]="true"
        dataKey="id"
        currentPageReportTemplate="  {first} à {last} sur {totalRecords} packings"
        [showCurrentPageReport]="true"
        [rowsPerPageOptions]="[10, 20, 30]"
        [loading]="loading"
    >
        <ng-template #caption>
            <div class="flex items-center justify-between">
                <h5 class="m-0">Gestion des Packings</h5>
                <p-iconfield>
                    <p-inputicon styleClass="pi pi-search" />
                    <input pInputText type="text" (input)="onGlobalFilter(dt, $event)" placeholder="Rechercher..." />
                </p-iconfield>
            </div>
        </ng-template>

        <ng-template #header>
            <tr>
                <th pSortableColumn="prestataire.nom">
                    <span class="col-header">Prestataire <p-sortIcon field="prestataire.nom" /></span>
                </th>
                <th><span class="col-header">Téléphone</span></th>
                <th pSortableColumn="date">
                    <span class="col-header">Date <p-sortIcon field="date" /></span>
                </th>
                <th pSortableColumn="nb_rouleaux" class="text-right">
                    <span class="col-header justify-end">Rouleaux <p-sortIcon field="nb_rouleaux" /></span>
                </th>
                <th pSortableColumn="montant" class="text-right">
                    <span class="col-header justify-end">Montant <p-sortIcon field="montant" /></span>
                </th>
                <th pSortableColumn="statut" class="text-center">
                    <span class="col-header justify-center">Statut <p-sortIcon field="statut" /></span>
                </th>
                <th class="text-center" style="width: 5rem"></th>
            </tr>
        </ng-template>

        <ng-template #body let-packing>
            <tr class="table-row" (dblclick)="canUpdate && editPacking(packing)">
                <td>
                    <div class="cell-prestataire" *ngIf="packing.prestataire">
                        <span class="cell-prestataire__avatar" [style.background]="'var(--p-primary-50)'" [style.color]="'var(--p-primary-600)'">
                            {{ packing.prestataire.nom?.charAt(0)?.toUpperCase() }}
                        </span>
                        <span class="cell-prestataire__name">{{ packing.prestataire.nom }} {{ packing.prestataire.prenom }}</span>
                    </div>
                </td>
                <td class="cell-secondary cell-bold">
                    <span *ngIf="packing.prestataire">{{ packing.prestataire.phone | phoneFormat:'INT' }}</span>
                </td>

                <td class="cell-secondary cell-bold">{{ formatDateDisplay(packing.date) }}</td>

                <td class="text-right cell-mono cell-bold">{{ packing.nb_rouleaux }}</td>

                <td class="text-right cell-mono cell-bold">{{ formatCurrency(packing.montant) }}</td>
                <td class="text-center">
                    <span class="status-badge" [ngClass]="{
                        'status-badge--warn': packing.statut === 'a_valider',
                        'status-badge--success': packing.statut === 'valide',
                        'status-badge--danger': packing.statut === 'annule'
                    }">
                        {{ getStatutLabel(packing.statut) }}
                    </span>
                </td>
                <td class="text-center">
                    <p-button *ngIf="canUpdate" icon="pi pi-arrow-right" severity="secondary" [text]="true" [rounded]="true" pTooltip="Modifier" (click)="editPacking(packing)" />
                </td>
            </tr>
        </ng-template>

        <ng-template #emptymessage>
            <tr>
                <td colspan="7">
                    <div class="empty-state">
                        <i class="pi pi-inbox"></i>
                        <span>Aucun packing trouvé</span>
                    </div>
                </td>
            </tr>
        </ng-template>
    </p-table>
</div>

<p-dialog
    [(visible)]="packingDialog"
    [style]="{ width: '750px', maxWidth: '95vw' }"
    [contentStyle]="{ overflow: 'visible' }"
    [header]="packing?.id ? 'Détails du packing' : 'Nouveau packing'"
    [modal]="true"
    styleClass="packing-dialog"
    [breakpoints]="{ '960px': '95vw' }"
>
    <div class="packing-dialog-content">
        <section class="packing-dialog-section">
            <h3 class="packing-dialog-section-title">Prestataire</h3>
            <div class="packing-dialog-field">
                <label for="prestataire">Machiniste</label>
                <p-skeleton *ngIf="dialogLoading" height="2.75rem" styleClass="w-full" />
                <p-select
                    *ngIf="!dialogLoading"
                    id="prestataire"
                    [(ngModel)]="selectedPrestataire"
                    [options]="prestataires"
                    optionLabel="nom"
                    [filter]="true"
                    filterBy="nom,prenom,phone"
                    placeholder="Sélectionner un prestataire"
                    styleClass="w-full packing-dialog-select"
                >
                    <ng-template let-prestataire pTemplate="item">
                        <div class="flex items-center gap-2">
                            <i class="pi pi-user text-primary"></i>
                            <span>{{ prestataire.prenom }} {{ prestataire.nom }} · {{ prestataire.phone }}</span>
                        </div>
                    </ng-template>
                    <ng-template let-prestataire pTemplate="selectedItem">
                        <div class="flex items-center gap-2" *ngIf="prestataire">
                            <i class="pi pi-user text-primary"></i>
                            <span>{{ prestataire.prenom }} {{ prestataire.nom }}</span>
                        </div>
                    </ng-template>
                </p-select>
                <small class="packing-dialog-error" *ngIf="submitted && !selectedPrestataire && !dialogLoading">Le prestataire est requis.</small>
            </div>
        </section>

        <section class="packing-dialog-section">
            <h3 class="packing-dialog-section-title">Informations</h3>
            <div class="packing-dialog-field">
                <label for="date">Date</label>
                <p-datepicker
                    id="date"
                    [(ngModel)]="packing.date"
                    dateFormat="dd/mm/yy"
                    [showIcon]="true"
                    inputStyleClass="w-full"
                    styleClass="w-full"
                />
            </div>
            <div class="packing-dialog-row">
                <div class="packing-dialog-field">
                    <label for="nb_rouleaux">Nombre de rouleaux</label>
                    <p-inputnumber
                        id="nb_rouleaux"
                        [(ngModel)]="packing.nb_rouleaux"
                        (onInput)="calculateMontant()"
                        [min]="0"
                        styleClass="w-full"
                    />
                </div>
                <div class="packing-dialog-field">
                    <label for="prix_par_rouleau">Prix / rouleau (GNF)</label>
                    <p-skeleton *ngIf="dialogLoading" height="2.75rem" styleClass="w-full" />
                    <p-inputnumber
                        *ngIf="!dialogLoading"
                        id="prix_par_rouleau"
                        [(ngModel)]="packing.prix_par_rouleau"
                        (onInput)="calculateMontant()"
                        [min]="0"
                        styleClass="w-full"
                    />
                </div>
            </div>
            <div class="packing-dialog-field">
                <label for="statut">Statut</label>
                <p-select
                    id="statut"
                    [(ngModel)]="packing.statut"
                    [options]="statuses"
                    optionLabel="label"
                    optionValue="value"
                    placeholder="Sélectionner un statut"
                    styleClass="w-full packing-dialog-select"
                />
            </div>
        </section>

        <div class="packing-dialog-total">
            <span class="packing-dialog-total-label">Montant total</span>
            <span class="packing-dialog-total-value">{{ formatCurrency(packing.montant || 0) }}</span>
        </div>
    </div>

    <ng-template #footer>
        <div class="packing-dialog-footer">
            <p-button label="Annuler" icon="pi pi-times" severity="secondary" [outlined]="true" (click)="hideDialog()" [disabled]="saving" />
            <p-button label="Enregistrer" icon="pi pi-check" (click)="savePacking()" [disabled]="saving || dialogLoading" [loading]="saving" />
        </div>
    </ng-template>
</p-dialog>

<p-confirmdialog [style]="{ width: '450px' }" />

