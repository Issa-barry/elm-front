<div class="card">
  <div class="flex justify-between items-center mb-6">
    <span class="text-surface-900 dark:text-surface-0 text-xl font-bold">
      {{ mode === 'create' ? 'Nouveau packing' : 'Détails du packing' }}
    </span>

    <!-- Bouton Modifier -->
    <button
      *ngIf="mode === 'edit' && !isEditing"
      pButton
      pRipple
      severity="warn"
      (click)="enableEditing()"
      class="w-auto">
      <i class="pi pi-pencil mr-2"></i>
      Modifier
    </button>  
  </div>

  <div class="grid grid-cols-12 gap-4">
    <div class="col-span-12 lg:col-span-2">
    </div> 

    <div class="col-span-12 lg:col-span-10">
      <div class="grid grid-cols-12 gap-4"> 

        <!-- Prestataire -->
        <div class="mb-6 col-span-12">
          <label for="prestataire" class="font-medium text-surface-900 dark:text-surface-0 mb-2 block">
            Prestataire <span class="text-red-500" *ngIf="isEditing">*</span> (Machiniste)
          </label>
          <p-select
            id="prestataire"
            [(ngModel)]="model.prestataire_id"
            [options]="filteredPrestataires"
            optionLabel="nom"
            optionValue="id"
            placeholder="Sélectionnez un machiniste"
            [filter]="true"
            filterBy="nom,prenom,phone"
            [showClear]="true"
            [disabled]="fieldsDisabled"
            fluid>
            <ng-template let-prestataire pTemplate="item">
              <div class="flex items-center gap-3">
                <div class="flex items-center justify-center w-10 h-10 rounded-full bg-primary/10">
                  <i class="pi pi-user text-primary"></i>
                </div>
                <div>
                  <div class="font-medium">{{ prestataire.prenom }} {{ prestataire.nom }}</div>
                  <div class="text-sm text-surface-500">{{ prestataire.phone }}</div>
                </div>
              </div>
            </ng-template>

            <ng-template let-prestataire pTemplate="selectedItem">
              <div class="flex items-center gap-2" *ngIf="prestataire">
                <i class="pi pi-user text-primary"></i>
                <span>{{ prestataire.prenom }} {{ prestataire.nom }}</span>
              </div>
            </ng-template>
          </p-select>
          <small class="text-red-500" *ngIf="submitted && !model.prestataire_id && isEditing">
            Veuillez sélectionnez un machiniste
          </small>
        </div>

        <!-- Date -->
        <div class="mb-6 col-span-12 md:col-span-6">
          <label for="date" class="font-medium text-surface-900 dark:text-surface-0 mb-2 block">
            Date <span class="text-red-500" *ngIf="isEditing">*</span>
          </label>
          <p-datepicker
            id="date"
            [(ngModel)]="model.date"
            [showIcon]="true"
            dateFormat="dd/mm/yy"
            placeholder="Sélectionnez la date"
            [disabled]="fieldsDisabled"
            (onSelect)="onDateChange()"
            (onBlur)="onDateBlur()"
            fluid />
          <small class="text-red-500 block mt-1" *ngIf="submitted && dateError && isEditing">
            {{ dateError }}
          </small>
        </div>

        <!-- Nombre de rouleaux et Prix unitaire -->
        <div class="mb-6 col-span-12 grid grid-cols-12 gap-3">
          <!-- Nombre de rouleaux -->
          <div class="col-span-12 md:col-span-6">
            <label for="nbRouleaux" class="font-medium text-surface-900 dark:text-surface-0 mb-2 block">
              Nombre de rouleaux <span class="text-red-500" *ngIf="isEditing">*</span>
            </label>
            <p-inputnumber
              id="nbRouleaux"
              [(ngModel)]="model.nb_rouleaux"
              (ngModelChange)="onPrixOrQuantityChange()"
              [showButtons]="true"
              [min]="1"
              [max]="9999"
              placeholder="Entrez le nombre"
              mode="decimal"
              [useGrouping]="false"
              [disabled]="fieldsDisabled"
              fluid />
            <small class="text-red-500" *ngIf="submitted && (!model.nb_rouleaux || model.nb_rouleaux < 1) && isEditing">
              Le nombre de rouleaux doit être supérieur à 0
            </small>
          </div>

          <!-- Prix unitaire -->
          <div class="col-span-12 md:col-span-6">
            <label for="prixRouleau" class="font-medium text-surface-900 dark:text-surface-0 mb-2 block">
              Prix unitaire (GNF) <span class="text-red-500" *ngIf="isEditing">*</span>
            </label>
            <p-inputnumber
              id="prixRouleau"
              [(ngModel)]="model.prix_par_rouleau"
              (ngModelChange)="onPrixOrQuantityChange()"
              mode="currency"
              currency="GNF"
              locale="fr-GN"
              [min]="0"
              placeholder="Prix par rouleau"
              [disabled]="fieldsDisabled"
              fluid />
            <small class="text-red-500" *ngIf="submitted && (!model.prix_par_rouleau || model.prix_par_rouleau <= 0) && isEditing">
              Le prix unitaire doit être supérieur à 0
            </small>
          </div>
        </div>

        <!-- Montant total (toujours visible) -->
        <div class="mb-6 col-span-12">
          <div class="bg-gradient-to-r from-primary/10 to-primary/5 border-l-4 border-primary rounded-lg p-4">
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-3">
                <div class="w-12 h-12 rounded-full bg-primary/20 flex items-center justify-center">
                  <i class="pi pi-money-bill text-primary text-xl"></i>
                </div>
                <div>
                  <div class="text-xs text-surface-600 dark:text-surface-400 mb-1">
                    Montant total
                  </div>
                  <div class="text-3xl font-bold text-primary">
                    {{ model.montant | money }}
                  </div>
                </div>
              </div>
            </div>
            <div class="text-sm text-surface-600 dark:text-surface-300 mt-3 flex items-center gap-2" *ngIf="model.nb_rouleaux && model.prix_par_rouleau">
              <i class="pi pi-calculator text-surface-500"></i>
              {{ model.nb_rouleaux }} rouleaux × {{ model.prix_par_rouleau | number:'1.0-0' }} GNF
            </div>
            <div class="text-sm text-surface-500 dark:text-surface-400 mt-3 italic" *ngIf="!model.nb_rouleaux || !model.prix_par_rouleau">
              <i class="pi pi-info-circle mr-2"></i>
              Entrez la quantité et le prix unitaire pour calculer le montant
            </div>
          </div>
        </div>

        <!-- Récapitulatif complet -->
        <div class="col-span-12 mb-6" *ngIf="model.prestataire_id && model.date && model.nb_rouleaux && model.prix_par_rouleau && !hasErrors()">
          <div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-5">
            <div class="flex items-center gap-2 mb-4">
              <i class="pi pi-info-circle text-blue-600 dark:text-blue-400 text-lg"></i>
              <span class="font-bold text-blue-900 dark:text-blue-100 text-lg">Récapitulatif</span>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <!-- Colonne 1 : Informations prestataire et pér période -->
              <div class="space-y-3">
                <div class="flex items-start gap-3">
                  <i class="pi pi-user text-blue-600 mt-1"></i>
                  <div class="flex-1">
                    <div class="text-xs text-surface-600 dark:text-surface-400 mb-1">Prestataire</div>
                    <div class="font-semibold text-surface-900 dark:text-surface-0">
                      {{ getSelectedPrestataire()?.prenom }} {{ getSelectedPrestataire()?.nom }}
                    </div>
                    <div class="text-sm text-surface-500 dark:text-surface-400">
                      {{ getSelectedPrestataire()?.phone }}
                    </div>
                  </div>
                </div>

                <div class="flex items-start gap-3">
                  <i class="pi pi-calendar text-blue-600 mt-1"></i>
                  <div class="flex-1">
                    <div class="text-xs text-surface-600 dark:text-surface-400 mb-1">Date</div>
                    <div class="font-medium text-surface-900 dark:text-surface-0">
                      {{ model.date | date:'dd/MM/yyyy' }}
                    </div>
                  </div>
                </div>
              </div>

              <!-- Colonne 2 : Informations financières -->
              <div class="space-y-3">
                <div class="flex items-start gap-3">
                  <i class="pi pi-box text-blue-600 mt-1"></i>
                  <div class="flex-1">
                    <div class="text-xs text-surface-600 dark:text-surface-400 mb-1">Quantité</div>
                    <div class="font-bold text-primary text-xl">
                      {{ model.nb_rouleaux }} rouleaux
                    </div>
                  </div>
                </div>

                <div class="flex items-start gap-3">
                  <i class="pi pi-tag text-blue-600 mt-1"></i>
                  <div class="flex-1">
                    <div class="text-xs text-surface-600 dark:text-surface-400 mb-1">Prix unitaire</div>
                    <div class="font-medium text-surface-900 dark:text-surface-0">
                      {{ model.prix_par_rouleau | number:'1.0-0' }} GNF
                    </div>
                  </div>
                </div>

                <div class="flex items-start gap-3 pt-3 border-t border-blue-200 dark:border-blue-700">
                  <i class="pi pi-wallet text-blue-600 mt-1"></i>
                  <div class="flex-1">
                    <div class="text-xs text-surface-600 dark:text-surface-400 mb-1">Montant total</div>
                    <div class="font-bold text-primary text-2xl">
                      {{ model.montant | number:'1.0-0' }} GNF
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Boutons d'action -->
        <div class="col-span-12 flex gap-2 mb-4" *ngIf="isEditing">
          <button
            pButton
            pRipple
            (click)="onSubmit()"
            [disabled]="!isValid() || loading"
            class="w-auto">
            <i class="pi" [ngClass]="loading ? 'pi-spin pi-spinner' : 'pi-check'" [class.mr-2]="!loading"></i>
            <span *ngIf="!loading">{{ mode === 'create' ? 'Enregistrer' : 'Sauvegarder' }}</span>
            <span *ngIf="loading">Enregistrement...</span>
          </button>

          <button
            pButton
            pRipple
            severity="secondary"
            (click)="mode === 'create' ? onCancel() : cancelEditing()"
            [disabled]="loading"
            class="w-auto">
            <i class="pi pi-times mr-2"></i>
            Annuler
          </button>
        </div>

      </div>
    </div>
  </div>
</div>


